/* js/verses.js
   Bible citation hovercards using site-internal JSON data.
   Works with both auto-detected refs and <span class="verse" data-ref="...">.
*/

(() => {
  const ROOT = '/israelite-research/data';
  const TRANSLATION_ORDER = ['KJV','Darby','Text','text'];
  const cache = new Map();

  // Canonical book → canon folder
  const BOOK_CANON = {
    // Tanakh
    'Genesis':'tanakh','Exodus':'tanakh','Leviticus':'tanakh','Numbers':'tanakh','Deuteronomy':'tanakh',
    'Joshua':'tanakh','Judges':'tanakh','Ruth':'tanakh',
    '1-Samuel':'tanakh','2-Samuel':'tanakh','1-Kings':'tanakh','2-Kings':'tanakh',
    '1-Chronicles':'tanakh','2-Chronicles':'tanakh',
    'Ezra':'tanakh','Nehemiah':'tanakh','Esther':'tanakh',
    'Job':'tanakh','Psalms':'tanakh','Proverbs':'tanakh','Ecclesiastes':'tanakh','Song-of-Solomon':'tanakh',
    'Isaiah':'tanakh','Jeremiah':'tanakh','Lamentations':'tanakh','Ezekiel':'tanakh','Daniel':'tanakh',
    'Hosea':'tanakh','Joel':'tanakh','Amos':'tanakh','Obadiah':'tanakh','Jonah':'tanakh','Micah':'tanakh',
    'Nahum':'tanakh','Habakkuk':'tanakh','Zephaniah':'tanakh','Haggai':'tanakh','Zechariah':'tanakh','Malachi':'tanakh',

    // New Testament
    'Matthew':'newtestament','Mark':'newtestament','Luke':'newtestament','John':'newtestament','Acts':'newtestament',
    'Romans':'newtestament','1-Corinthians':'newtestament','2-Corinthians':'newtestament','Galatians':'newtestament',
    'Ephesians':'newtestament','Philippians':'newtestament','Colossians':'newtestament',
    '1-Thessalonians':'newtestament','2-Thessalonians':'newtestament',
    '1-Timothy':'newtestament','2-Timothy':'newtestament','Titus':'newtestament','Philemon':'newtestament',
    'Hebrews':'newtestament','James':'newtestament','1-Peter':'newtestament','2-Peter':'newtestament',
    '1-John':'newtestament','2-John':'newtestament','3-John':'newtestament','Jude':'newtestament','Revelation':'newtestament',

    // Apocrypha (sample)
    '1-Maccabees':'apocrypha','2-Maccabees':'apocrypha','Wisdom':'apocrypha','Sirach':'apocrypha',
    'Tobit':'apocrypha','Judith':'apocrypha','Baruch':'apocrypha'
  };

  // Abbreviations → canonical
  const BOOK_MAP = {
    'Gen':'Genesis','Ge':'Genesis','Gn':'Genesis',
    'Ex':'Exodus','Lev':'Leviticus','Num':'Numbers','Deut':'Deuteronomy',
    'Josh':'Joshua','Judg':'Judges','Ruth':'Ruth',
    '1Sam':'1-Samuel','2Sam':'2-Samuel','1Kgs':'1-Kings','2Kgs':'2-Kings',
    '1Chr':'1-Chronicles','2Chr':'2-Chronicles',
    'Ezra':'Ezra','Neh':'Nehemiah','Esth':'Esther',
    'Job':'Job','Ps':'Psalms','Psa':'Psalms','Psalm':'Psalms','Psalms':'Psalms',
    'Prov':'Proverbs','Eccl':'Ecclesiastes',
    'Song':'Song-of-Solomon','SoS':'Song-of-Solomon','Song of Songs':'Song-of-Solomon','Cant':'Song-of-Solomon',
    'Isa':'Isaiah','Jer':'Jeremiah','Lam':'Lamentations','Ezek':'Ezekiel','Dan':'Daniel',
    'Hos':'Hosea','Joel':'Joel','Amos':'Amos','Obad':'Obadiah','Jonah':'Jonah','Mic':'Micah',
    'Nah':'Nahum','Hab':'Habakkuk','Zeph':'Zephaniah','Hag':'Haggai','Zech':'Zechariah','Mal':'Malachi',

    'Matt':'Matthew','Mt':'Matthew','Mark':'Mark','Mk':'Mark','Luke':'Luke','Lk':'Luke','John':'John','Jn':'John',
    'Acts':'Acts','Rom':'Romans','1Cor':'1-Corinthians','2Cor':'2-Corinthians',
    'Gal':'Galatians','Eph':'Ephesians','Phil':'Philippians','Col':'Colossians',
    '1Thess':'1-Thessalonians','2Thess':'2-Thessalonians',
    '1Tim':'1-Timothy','2Tim':'2-Timothy','Titus':'Titus','Phlm':'Philemon',
    'Heb':'Hebrews','Jas':'James','James':'James','1Pet':'1-Peter','2Pet':'2-Peter',
    '1John':'1-John','2John':'2-John','3John':'3-John','Jude':'Jude','Rev':'Revelation'
  };

  function slugifyBook(bookCanonical){
    return bookCanonical.toLowerCase().replace(/\s+/g,'-');
  }
  function canonFor(bookCanonical){ return BOOK_CANON[bookCanonical] || 'tanakh'; }

  // Parse refs
  function parseRef(ref){
    const m = ref.match(/^\s*([^\d]+?)\s+(\d+)(?::([\d,\-\s]+))?\s*$/);
    if (!m) return null;
    const abbr = m[1].trim();
    const chapter = parseInt(m[2],10);
    const bookCanonical = BOOK_MAP[abbr] || abbr;
    if (!m[3]) return {bookCanonical, chapter, parts:[{type:'chapter'}]};
    const parts = [];
    m[3].split(',').forEach(seg=>{
      const s = seg.trim();
      if (!s) return;
      if (s.includes('-')) {
        const [a,b] = s.split('-').map(x=>parseInt(x.trim(),10));
        if (!isNaN(a) && !isNaN(b)) parts.push({type:'range', from:Math.min(a,b), to:Math.max(a,b)});
      } else {
        const v = parseInt(s,10);
        if (!isNaN(v)) parts.push({type:'single', from:v, to:v});
      }
    });
    return {bookCanonical, chapter, parts};
  }

  async function getChapter(bookCanonical, chapter){
    const key = `${bookCanonical}|${chapter}`;
    if (cache.has(key)) return cache.get(key);
    const canon = canonFor(bookCanonical);
    const slug  = slugifyBook(bookCanonical);
    const url   = `${ROOT}/${canon}/${slug}/${chapter}.json`;
    const res = await fetch(url, {cache:'force-cache'});
    if (!res.ok) throw new Error(`Missing chapter data: ${url}`);
    const json = await res.json();
    cache.set(key, json);
    return json;
  }

  function pickTranslation(chapterJson){
    for (const k of TRANSLATION_ORDER){
      if (chapterJson[k]) return chapterJson[k];
    }
    if (Array.isArray(chapterJson.verses)) return chapterJson.verses;
    return chapterJson;
  }

  function extractVerses(trans, parts){
    const getVerse = (n)=>{
      if (Array.isArray(trans)) {
        const hit = trans.find(x => (x.v ?? x.verse) == n);
        return hit ? (hit.t ?? hit.text ?? '') : '';
      } else if (typeof trans === 'object'){
        return trans[n] || '';
      }
      return '';
    };
    const chunks = [];
    for (const p of parts){
      if (p.type==='single'){
        const t = getVerse(p.from);
        if (t) chunks.push({label:`v${p.from}`, text:escapeHtml(t)});
      }
      if (p.type==='range'){
        const lines = [];
        for (let v=p.from; v<=p.to; v++){
          const t = getVerse(v);
          if (t) lines.push(`<span class="vr">${v}</span> ${escapeHtml(t)}`);
        }
        if (lines.length) chunks.push({label:`v${p.from}-${p.to}`, text:lines.join('<br>')});
      }
    }
    return chunks;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]
    ));
  }

  function autosummarizeChapter(chapterJson){
    const builtIn = chapterJson.summary || null;
    if (builtIn) return builtIn;
    return `This chapter has ${Object.keys(pickTranslation(chapterJson)).length} verses.`;
  }

  // Hovercard UI (simplified)
  function ensureHoverContainer(){
    let hc = document.querySelector('#bible-hovercard');
    if (hc) return hc;
    hc = document.createElement('div');
    hc.id = 'bible-hovercard';
    hc.innerHTML = `<div class="bh-inner"><div class="bh-header"><span class="bh-ref"></span><button class="bh-close">&times;</button></div><div class="bh-body"></div></div>`;
    document.body.appendChild(hc);
    hc.querySelector('.bh-close').addEventListener('click', hideHover);
    return hc;
  }
  function showHoverFor(el, html){
    const hc = ensureHoverContainer();
    hc.querySelector('.bh-ref').textContent = el.dataset.ref;
    hc.querySelector('.bh-body').innerHTML = html;
    hc.style.opacity = '1'; hc.setAttribute('aria-hidden','false');
    const rect = el.getBoundingClientRect();
    hc.style.top = (window.scrollY + rect.bottom + 8)+'px';
    hc.style.left = (window.scrollX + rect.left)+'px';
  }
  function hideHover(){
    const hc = document.querySelector('#bible-hovercard');
    if (!hc) return;
    hc.style.opacity = '0'; hc.setAttribute('aria-hidden','true');
  }

  async function handleEnterLikeSpan(el){
    const ref = el.dataset.ref;
    try {
      const parsed = parseRef(ref);
      const chapterJson = await getChapter(parsed.bookCanonical, parsed.chapter);
      const trans = pickTranslation(chapterJson);
      let html = '';
      if (parsed.parts.some(p=>p.type==='chapter')){
        html += `<div>${escapeHtml(autosummarizeChapter(chapterJson))}</div>`;
      }
      const chunks = extractVerses(trans, parsed.parts.filter(p=>p.type!=='chapter'));
      chunks.forEach(c=>{
        html += `<div><strong>${c.label}</strong>: ${c.text}</div>`;
      });
      showHoverFor(el, html);
    } catch (e){
      showHoverFor(el, `<div>Couldn’t load: ${ref}</div>`);
    }
  }

  function bindExistingVerseSpans(root=document){
    root.querySelectorAll('.verse[data-ref]').forEach(el=>{
      el.addEventListener('mouseenter', ()=>handleEnterLikeSpan(el));
      el.addEventListener('mouseleave', hideHover);
    });
  }

  function init(){
    bindExistingVerseSpans(document);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

})();
