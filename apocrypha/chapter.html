<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Chapter — Israelite Research</title>
<link href="/israelite-research/styles.css" rel="stylesheet"/>
<style>
  :root{--ink:#0b2340;--accent:#F17300;--brand:#054A91;--muted:#6b7280;--sky:#DBE4EE;--white:#fff}

  /* Layout */
  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .page-header{padding:24px 0 8px}
  .page-title{margin:0;font-size:2rem;font-weight:800;color:var(--ink)}
  .crumbs{color:var(--muted);font-size:.9rem;margin-top:4px}

  .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin:16px 0 40px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}

  .panel{background:var(--white);border:1px solid var(--sky);border-radius:10px;padding:14px}

  /* Chapter grid (used on book overview screens if you show them here) */
  .grid{display:grid;grid-template-columns:repeat(5,minmax(44px,1fr));gap:10px;margin:12px 0 0}
  .ch{display:flex;align-items:center;justify-content:center;height:44px;border:1px solid var(--sky);background:var(--white);text-decoration:none;color:var(--brand);font-weight:800}
  .ch:hover{box-shadow:0 4px 10px rgba(0,0,0,.06);transform:translateY(-1px)}

  /* Reader toolbar */
  .reader-toolbar{
    position: sticky; top: 0; z-index: 50;
    display:flex; align-items:center; justify-content:center; gap:.75rem;
    background:#fff; border:1px solid var(--sky); border-radius:10px;
    padding:.5rem; margin:10px 0 16px; box-shadow:0 1px 6px rgba(0,0,0,.05);
  }
  .reader-toolbar .btn{
    padding:.45rem .7rem; border:1px solid #e6ebf2; background:#fff; border-radius:10px; cursor:pointer; font:inherit;
  }
  .reader-toolbar .btn:hover{ background:#f8fafc }
  .reader-toolbar .ch-picker select{
    border:1px solid #e6ebf2; border-radius:10px; padding:.45rem .6rem; font:inherit;
  }

  /* Verse rows */
  .verse{display:flex; flex-direction:column; gap:.35rem; margin:.55rem 0; padding:.35rem .1rem; border-bottom:1px dashed var(--sky)}
  .vline{display:flex; gap:.6rem}
  .vnum{min-width:28px; text-align:right; color:var(--muted)}
  .vtext{line-height:1.55; color:#111}
  .v-toolbar{display:flex; gap:.4rem; padding-left:36px}
  .v-toolbar button{
    border:1px solid #e6ebf2; background:#fff; border-radius:8px; padding:.22rem .5rem; font-size:.82rem; cursor:pointer;
  }
  .v-toolbar button:hover{ background:#f8fafc }

  /* Hovercard for dictionary */
  .hovercard{
    position:fixed; z-index:9999; display:none; max-width:min(380px, 92vw);
    background:#fff; border:1px solid #e6ebf2; border-radius:10px;
    box-shadow:0 8px 30px rgba(0,0,0,.12);
    padding:.6rem .7rem; font-size:.9rem;
  }
  .hovercard.open{ display:block }

  /* Inline “verse” spans kept for your site-wide tooltip JS */
  .verse-ref{position:relative;text-decoration:underline dotted;cursor:help;color:var(--brand);font-weight:600;}
  .verse-ref:hover::after{opacity:1; transform:translateY(0);}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <header class="page-header">
    <h1 class="page-title" id="bookTitle">Loading…</h1>
    <div class="crumbs" id="crumbs"></div>
  </header>

  <div aria-label="Chapter navigation" class="reader-toolbar" id="readerToolbar" role="navigation">
    <button aria-label="Previous chapter" class="btn prev" id="btnPrev">← Prev</button>
    <div class="ch-picker">
      <label class="sr-only" for="chSelect">Select chapter</label>
      <select id="chSelect"></select>
    </div>
    <button aria-label="Next chapter" class="btn next" id="btnNext">Next →</button>
  </div>

  <section class="layout">
    <div class="panel">
      <h3 id="textPanelTitle">Text</h3>
      <div id="verses"><p class="muted">Loading…</p></div>
    </div>

    <aside class="panel" id="dictAside">
      <h3>Bible Dictionary</h3>
      <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
        <input id="dictSearch" placeholder="Search term (e.g., Eden, Covenant)…" style="flex:1; border:1px solid #DBE4EE; border-radius:10px; padding:.5rem .6rem" type="search"/>
      </div>
      <div id="dictPanel"><p class="muted">Loading Bible Dictionary…</p></div>
    </aside>
  </section>
</main>

<div id="site-footer"></div>
<div aria-hidden="true" class="hovercard" id="hovercard" role="dialog"></div>

<script src="/israelite-research/js/include.js"></script>
<script>
(function(){
  // --- URL params ---
  const params = new URLSearchParams(location.search);
  const bookSlug = (params.get('book') || '').trim();  // e.g., 'ii-esdras', 'genesis'
  const ch = parseInt(params.get('ch') || '1', 10);

  // --- Helpers ---
  function titleCaseFromSlug(slug){
    if(!slug) return '';
    const parts = slug.split('-');
    // Normalize leading roman numerals (i, ii, iii) → I, II, III
    const romans = { i:'I', ii:'II', iii:'III', iv:'IV', v:'V', vi:'VI', vii:'VII', viii:'VIII', ix:'IX', x:'X' };
    if(parts.length && romans[parts[0]]) parts[0] = romans[parts[0]];
    return parts.map((p,i)=> i===0 && romans[p] ? romans[p] : p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
  }

  function setBookTitle(){
    const title = titleCaseFromSlug(bookSlug) || 'Chapter';
    document.getElementById('bookTitle').textContent = title;
    document.title = title + ' — Chapter';
    document.getElementById('textPanelTitle').textContent = title + ' ' + (Number.isFinite(ch)? ch : '');
    document.getElementById('crumbs').textContent = title + (Number.isFinite(ch)? (' • Chapter ' + ch) : '');
  }

  // --- Chapter select wiring (client-side only; adjust total dynamically if you load metadata) ---
  const chSelect = document.getElementById('chSelect');
  function populateChapterPicker(total=50){ // default generous cap; update if you load real totals
    chSelect.innerHTML = '';
    for(let i=1;i<=total;i++){
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = 'Chapter ' + i;
      if(i===ch) opt.selected = true;
      chSelect.appendChild(opt);
    }
  }
  function goToChapter(n){
    const qs = new URLSearchParams(location.search);
    qs.set('ch', String(n));
    location.search = qs.toString();
  }
  document.getElementById('btnPrev').addEventListener('click', ()=> ch>1 && goToChapter(ch-1));
  document.getElementById('btnNext').addEventListener('click', ()=> goToChapter(ch+1));
  chSelect.addEventListener('change', (e)=> goToChapter(parseInt(e.target.value,10)||1));

  <script>
(function(){
  // ... keep all earlier code above this line (title, picker, dictionary, etc.) ...

  // --- Detect collection from URL path ---
  function detectCollection(){
    const p = location.pathname;
    if (p.includes('/tanakh/')) return 'tanakh';
    if (p.includes('/newtestament/')) return 'newtestament';
    if (p.includes('/apocrypha/')) return 'apocrypha';
    return 'scripture';
  }

  // --- Verses target ---
  const versesEl = document.getElementById('verses');
  const collection = detectCollection();

  // Build canonical paths (adjust to your repo if needed)
  function jsonPath(bookSlug, ch){
    return `/israelite-research/data/chapters/${collection}/${bookSlug}/${ch}.json`;
  }
  function textPath(bookSlug, ch){
    return `/israelite-research/data/chapters/${collection}/${bookSlug}/${ch}.txt`;
  }

  // Split plain text into [{n,t}] using verse-number regex
  function splitPlainTextToVerses(txt){
    // Matches: "\n1 " or line-start "1) " or "1. " etc.
    const pattern = /(^|\n)\s*(\d{1,3})[.)]?\s+/g;
    const verses = [];
    let match, lastIdx = 0, lastNum = null;

    // Collect verse number boundaries
    const indices = [];
    while ((match = pattern.exec(txt)) !== null) {
      indices.push({ idx: match.index + match[0].length - (match[2].length + 1), num: parseInt(match[2], 10) });
    }
    // If no indices found, treat entire text as verse 1
    if (!indices.length) return [{ n: 1, t: txt.trim() }];

    for (let i = 0; i < indices.length; i++){
      const start = indices[i].idx + (indices[i].num.toString().length + 1);
      const end = (i+1 < indices.length) ? indices[i+1].idx : txt.length;
      const body = txt.slice(start, end).trim();
      verses.push({ n: indices[i].num, t: body });
    }
    return verses.filter(v => v.t);
  }

  // Render
  function renderVerses(verses){
    versesEl.innerHTML = '';
    verses.forEach(v=>{
      const wrap = document.createElement('div');
      wrap.className = 'verse';
      wrap.innerHTML = `
        <div class="vline">
          <div class="vnum">${v.n}</div>
          <div class="vtext">${v.t}</div>
        </div>
        <div class="v-toolbar">
          <button type="button" data-copy="${v.n}">Copy</button>
        </div>`;
      versesEl.appendChild(wrap);
    });

    // one-time wiring per load
    versesEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-copy]');
      if(!btn) return;
      const n = btn.getAttribute('data-copy');
      const text = `${document.getElementById('bookTitle').textContent.replace(' — Chapter','')} ${new URLSearchParams(location.search).get('ch')}:${n} — ` + btn.closest('.verse').querySelector('.vtext').textContent;
      navigator.clipboard.writeText(text);
      btn.textContent = 'Copied!';
      setTimeout(()=> btn.textContent='Copy', 900);
    }, { once:true });
  }

  async function loadChapter(){
    versesEl.innerHTML = '<p class="muted">Loading…</p>';
    const params = new URLSearchParams(location.search);
    const bookSlug = (params.get('book') || '').trim();
    const ch = parseInt(params.get('ch') || '1', 10);

    // 1) Try JSON
    try{
      const res = await fetch(jsonPath(bookSlug, ch), { cache: 'force-cache' });
      if (res.ok) {
        const data = await res.json();
        if (data && Array.isArray(data.verses) && data.verses.length){
          renderVerses(data.verses);
          return;
        }
      }
    }catch(_) {}

    // 2) Fallback to TXT
    try{
      const res = await fetch(textPath(bookSlug, ch), { cache: 'force-cache' });
      if (res.ok) {
        const txt = await res.text();
        const verses = splitPlainTextToVerses(txt);
        renderVerses(verses);
        return;
      }
    }catch(_) {}

    // 3) Fallback: graceful empty
    versesEl.innerHTML = '<p class="muted">Chapter data unavailable.</p>';
  }

  // Boot (leave your other boot calls intact)
  // setBookTitle(), populateChapterPicker(), loadDictionary() should already be present above.
  loadChapter();

  // ... keep the rest of your existing script (dictionary, picker wiring, etc.) below ...
})();
</script>

  // --- Bible Dictionary (Easton) ---
  const DICT_PATH = '/israelite-research/data/dictionaries/easton_dictionary.json';
  const dictPanel = document.getElementById('dictPanel');
  const dictSearch = document.getElementById('dictSearch');

  let dictIndex = [];
  function normalizeTerm(s){ return (s||'').trim().toLowerCase(); }

  async function loadDictionary(){
    try{
      const res = await fetch(DICT_PATH, {cache:'force-cache'});
      const data = await res.json();
      // Expecting array of entries: [{ term, definitions: [ ... ] }, ...]
      dictIndex = Array.isArray(data) ? data : [];
      dictPanel.innerHTML = '<p class="muted">Type a term above (e.g., “Abraham”, “Passover”, “Covenant”).</p>';
    }catch(err){
      dictPanel.innerHTML = '<p class="muted">Dictionary failed to load.</p>';
    }
  }

  function searchDictionary(q){
    const needle = normalizeTerm(q);
    if(!needle){ dictPanel.innerHTML = '<p class="muted">Type a term above (e.g., “Abraham”, “Passover”, “Covenant”).</p>'; return; }
    const hits = dictIndex.filter(e => normalizeTerm(e.term) === needle || normalizeTerm(e.term).includes(needle)).slice(0,6);
    if(!hits.length){ dictPanel.innerHTML = '<p class="muted">No entries found.</p>'; return; }
    dictPanel.innerHTML = hits.map(e=>{
      const defs = (e.definitions||[]).map(d=>`<li>${d}</li>`).join('');
      return `<article style="margin:.5rem 0">
        <h4 style="margin:.1rem 0 .2rem; color:var(--ink)">${e.term}</h4>
        <ol style="margin:.25rem 0 0 1.1rem">${defs}</ol>
      </article>`;
    }).join('');
  }

  dictSearch.addEventListener('input', (e)=> searchDictionary(e.target.value));

  // --- Boot ---
  setBookTitle();
  populateChapterPicker();     // (optionally detect real totals per book)
  loadChapter();
  loadDictionary();
})();
</script>
</body>
</html>
