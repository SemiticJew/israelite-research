<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Events — Semitic Jew</title>
<link href="/israelite-research/styles.css" rel="stylesheet"/>
<style>
  /* ===== Scoped calendar styles (stay on this page only) ===== */
  .events-page .container{max-width:1200px;margin:0 auto;padding:0 16px;}
  .events-page .calendar-wrap{max-width:1000px;margin:0 auto 40px;}

  .events-page .page-header{padding:24px 0 8px;}
  .events-page .page-title{margin:0;font-size:2rem;font-weight:800;}

  .cal-toolbar{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin:1rem 0 1.25rem;}
  .cal-title{font-size:1.25rem;margin:0;font-weight:700;}
  .cal-nav{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .btn{padding:.45rem .7rem;border:1px solid #e6ebf2;background:#fff;border-radius:10px;cursor:pointer}
  .btn:hover{background:#f8fafc}

  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-dow{background:#f8fafc;border:1px solid #e6ebf2;border-radius:10px;padding:.4rem 0;text-align:center;font-weight:600;color:#555}
  .cal-cell{height:110px;overflow:hidden;border:1px solid #e6ebf2;border-radius:10px;background:#fff;padding:.5rem;display:flex;flex-direction:column}
  .cal-cell.is-today{outline:2px solid var(--accent,#F17300)}
  .cal-date{font-size:.9rem;color:#333;margin-bottom:.35rem}
  .cal-empty{opacity:.35}

  /* Event chips (now dot + TIME — Title) */
  .evt-chip{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis;font-size:.82rem;line-height:1.2;background:#054A910D;border:1px solid #e6ebf2;border-radius:8px;padding:.25rem .35rem;margin:.15rem 0;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    display:flex;align-items:center;gap:.45rem;}
  .pill-dot{width:10px;height:10px;border-radius:50%;flex:0 0 10px;display:inline-block}

  /* Legend (interactive) */
  .cal-legend{display:flex;flex-wrap:wrap;gap:.75rem 1.25rem;align-items:center;margin:.75rem 0 0;color:#666;font-size:.9rem}
  .cal-legend button{display:inline-flex;align-items:center;gap:.5rem;font:inherit;font-size:.9rem;color:#444;background:#fff;border:1px solid #e6ebf2;border-radius:999px;padding:.3rem .6rem;cursor:pointer}
  .cal-legend button .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
  .cal-legend button[aria-pressed="false"]{opacity:.45}

  /* Dot colors */
  .dot.xspace  { background:#000000; }
  .dot.youtube { background:#8B0000; }
  .dot.discord { background:#5865f2; }
  .dot.sabbath { background:#054A91; }
  .dot.newmoon { background:#81A4CD; }
  .dot.feast   { background:#F17300; }

  /* ===== Modal (fixed layout/spacing) ===== */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:1rem;z-index:9999}
  .modal.open{display:flex}
  .modal-card{
    width:min(560px,92vw);
    max-height:90vh;
    background:#fff;border-radius:14px;border:1px solid #e6ebf2;box-shadow:0 8px 30px rgba(0,0,0,.12);
    display:flex;flex-direction:column;overflow:hidden
  }
  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid #eef2f7}
  .modal-title{font-size:1.1rem;margin:0}
  .modal-body{
    padding:1rem;
    overflow:auto;
    display:grid;
    gap:.9rem;
    grid-template-columns:1fr;
  }
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:.9rem}
  @media (max-width:640px){ .form-row{grid-template-columns:1fr;} }

  label{display:block;font-size:.9rem;color:#333;margin:0 0 .35rem}
  input[type="text"],input[type="date"],input[type="time"],textarea,select{
    width:100%;
    box-sizing:border-box;
    border:1px solid #e6ebf2;border-radius:10px;
    padding:.6rem .7rem;font:inherit;line-height:1.3;
    background:#fff;
  }
  textarea{min-height:130px;resize:vertical}

  .modal-foot{
    margin-top:auto;
    display:flex;justify-content:space-between;gap:.5rem;padding:.75rem 1rem 1rem;border-top:1px solid #eef2f7
  }
  .btn-primary{background:var(--accent,#F17300);color:#fff;border-color:transparent}
  .btn-danger{border-color:#ffd8d8;background:#fff;color:#b42318}
  .btn-ghost{background:transparent}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}

  /* ===== Day Details panel ===== */
  .day-details{margin-top:10px;border:1px solid #e6ebf2;border-radius:12px;background:#fff;overflow:hidden}
  .day-details[hidden]{display:none}
  .dd-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e6ebf2}
  .dd-title{margin:0;font-weight:800;font-size:1.05rem}
  .dd-close{border:1px solid #e6ebf2;background:#fff;border-radius:10px;padding:.35rem .6rem;cursor:pointer}
  .dd-body{padding:10px 12px;display:grid;gap:8px}
  .dd-item{border:1px solid #e6ebf2;border-radius:10px;padding:10px;display:grid;gap:4px}
  .dd-line{display:flex;align-items:center;gap:.5rem}
  .dd-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .dd-time{font-weight:700}
  .dd-title-txt{font-weight:700}
  .dd-notes{color:#555;font-size:.9rem;white-space:pre-wrap}
  .cal-dow{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
  .cal-dow .dow-main{font-weight:700;font-size:.95rem;color:#333}
  .cal-dow .dow-he{font-weight:500;font-size:.8rem;color:#555;margin-top:.15rem}
  .cal-dow .dow-tr{font-weight:400;font-size:.72rem;color:#777}

  /* ===== NEW: Tabs & ICS agenda ===== */
  .tabs-toolbar{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin:1rem 0 .75rem;}
  .tabs-left{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .tabs-right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .btn[aria-pressed="true"]{background:#054A910D;border-color:#cfd8e3}
  .panel{display:none}
  .panel.active{display:block}
  .agenda{display:grid;gap:.75rem;margin-top:.5rem}
  .card{border:1px solid #e6ebf2;border-radius:12px;background:#fff;padding:.9rem 1rem}
  .card h3{margin:.1rem 0 .25rem 0;font-size:1.05rem}
  .card .when{color:#6b7280;font-size:.95rem}
</style>
</head>
<body class="events-page">
<!-- Header partial -->
<div id="site-header"></div>

<main class="container">
  <!-- NEW: Tabs row (keeps your calendar toolbar untouched) -->
  <div class="tabs-toolbar">
    <div class="tabs-left">
      <button class="btn" id="tabSite" aria-pressed="true">Site Calendar</button>
      <button class="btn" id="tabICS" aria-pressed="false">High Holy Day ICS</button>
      <!-- Optional future Google
      <button class="btn" id="tabGoogle" aria-pressed="false">Google Calendar</button>
      -->
    </div>
    <div class="tabs-right">
      <a class="btn" href="/israelite-research/assets/cal/basic.ics" download>Download ICS</a>
      <a class="btn" href="webcal://semiticjew.github.io/israelite-research/assets/cal/basic.ics">Subscribe (webcal)</a>
    </div>
  </div>

  <!-- Site Calendar PANEL (your existing calendar lives here, unchanged) -->
  <section id="siteCalPanel" class="panel active" aria-labelledby="tabSite">
    <div class="calendar-wrap">
      <div class="cal-toolbar">
        <div class="cal-nav">
          <!-- Month / Day / Year selectors -->
          <select id="selMonth" aria-label="Month"></select>
          <select id="selDay" aria-label="Day"></select>
          <select id="selYear" aria-label="Year"></select>
        </div>
        <h2 class="cal-title" id="calTitle">Month YYYY</h2>
        <button class="btn btn-primary" id="addEventBtn">+ Add Event</button>
      </div>

      <div class="cal-grid" id="dowRow">
        <div class="cal-dow"><div class="dow-main">Sun</div><div class="dow-he">Yom Rishon</div><div class="dow-tr">"first day"</div></div><div class="cal-dow"><div class="dow-main">Mon</div><div class="dow-he">Yom Sheni</div><div class="dow-tr">"second day"</div></div><div class="cal-dow"><div class="dow-main">Tue</div><div class="dow-he">Yom Shlishi</div><div class="dow-tr">"third day"</div></div>
        <div class="cal-dow"><div class="dow-main">Wed</div><div class="dow-he">Yom Revi’i</div><div class="dow-tr">"fourth day"</div></div><div class="cal-dow"><div class="dow-main">Thu</div><div class="dow-he">Yom Chamishi</div><div class="dow-tr">"fifth day"</div></div><div class="cal-dow"><div class="dow-main">Fri</div><div class="dow-he">Yom Shishi</div><div class="dow-tr">"sixth day"</div></div><div class="cal-dow"><div class="dow-main">Sat</div><div class="dow-he">Yom Shabbat</div><div class="dow-tr">"Sabbath"</div></div>
      </div>

      <div aria-live="polite" class="cal-grid" id="calGrid"></div>

      <!-- Interactive Legend -->
      <div class="cal-legend" id="calLegend">
        <button type="button" data-type="generic" aria-pressed="true" title="Toggle generic events">
          <span class="dot" style="background:#054A91"></span> Event
        </button>
        <button type="button" data-type="xspace" aria-pressed="true" title="Toggle X Space">
          <span class="dot xspace"></span> X Space
        </button>
        <button type="button" data-type="youtube" aria-pressed="true" title="Toggle YouTube Live">
          <span class="dot youtube"></span> YouTube Live
        </button>
        <button type="button" data-type="discord" aria-pressed="true" title="Toggle Discord Live">
          <span class="dot discord"></span> Discord Live
        </button>
        <button type="button" data-type="sabbath" aria-pressed="true" title="Toggle Sabbath">
          <span class="dot sabbath"></span> Sabbath
        </button>
        <button type="button" data-type="newmoon" aria-pressed="true" title="Toggle New Moon">
          <span class="dot newmoon"></span> New Moon
        </button>
        <button type="button" data-type="feast" aria-pressed="true" title="Toggle Feast Days">
          <span class="dot feast"></span> Feast Days
        </button>
      </div>

      <!-- Day Details panel -->
      <aside class="day-details" id="dayDetails" hidden>
        <div class="dd-head">
          <h3 class="dd-title" id="ddTitle">Events</h3>
          <button class="dd-close" id="ddClose" aria-label="Close details">Close</button>
        </div>
        <div class="dd-body" id="ddBody"></div>
      </aside>
    </div>
  </section>

  <!-- ICS PANEL -->
  <section id="icsPanel" class="panel" aria-labelledby="tabICS">
    <div class="card">
      <h3>High Holy Day ICS</h3>
      <div class="when">Rendering upcoming entries from <code>assets/cal/basic.ics</code></div>
    </div>
    <div id="icsAgenda" class="agenda"></div>
  </section>

  <!-- Optional Google PANEL (commented for now)
  <section id="gcalPanel" class="panel" aria-labelledby="tabGoogle">
    <div style="position:relative;padding-top:56.25%;border:1px solid #e6ebf2;border-radius:12px;overflow:hidden">
      <iframe
        title="Semitic Jew — Google Calendar"
        style="position:absolute;inset:0;width:100%;height:100%;border:0"
        src="https://calendar.google.com/calendar/embed?src=YOUR_CALENDAR_ID%40group.calendar.google.com&ctz=America%2FNew_York&mode=AGENDA&showPrint=0&showTabs=0&showCalendars=0&wkst=1&showTitle=0">
      </iframe>
    </div>
  </section>
  -->
</main>

<!-- Footer partial -->
<div id="site-footer"></div>

<!-- Add/Edit Event Modal -->
<div aria-labelledby="modalTitle" aria-modal="true" class="modal" id="eventModal" role="dialog">
  <div class="modal-card">
    <div class="modal-head">
      <h3 class="modal-title" id="modalTitle">Add Event</h3>
      <button aria-label="Close" class="btn btn-ghost" id="closeModal">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-row">
        <div>
          <label for="evtDate">Date</label>
          <input id="evtDate" type="date"/>
        </div>
        <div>
          <label for="evtTime">Time <span class="muted">(optional)</span></label>
          <input id="evtTime" type="time"/>
        </div>
      </div>

      <div>
        <label for="evtTitle">Title</label>
        <input id="evtTitle" placeholder="e.g., Bible Study" type="text"/>
      </div>

      <!-- Type select -->
      <div>
        <label for="evtType">Type <span class="muted">(optional)</span></label>
        <select id="evtType">
          <option value="generic" selected>Generic</option>
          <option value="xspace">X Space</option>
          <option value="youtube">YouTube Live</option>
          <option value="discord">Discord Live</option>
          <option value="sabbath">Sabbath</option>
          <option value="newmoon">New Moon</option>
          <option value="feast">Feast Days</option>
        </select>
      </div>

      <div>
        <label for="evtDesc">Description <span class="muted">(optional)</span></label>
        <textarea id="evtDesc" placeholder="Notes, location, link…"></textarea>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn btn-danger" id="deleteEvent" style="display:none">Delete</button>
      <div style="margin-left:auto;display:flex;gap:.5rem">
        <button class="btn" id="cancelEvent">Cancel</button>
        <button class="btn btn-primary" id="saveEvent">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Partials include -->
<script src="/israelite-research/js/include.js"></script>

<!-- Calendar logic -->
<script>
(function(){
  // ===== DOM Refs =====
  const grid = document.getElementById('calGrid');
  const titleEl = document.getElementById('calTitle');
  const addEventBtn = document.getElementById('addEventBtn');

  const selMonth = document.getElementById('selMonth');
  const selDay   = document.getElementById('selDay');
  const selYear  = document.getElementById('selYear');

  const legend = document.getElementById('calLegend');

  const modal = document.getElementById('eventModal');
  const closeModal = document.getElementById('closeModal');
  const cancelEvent = document.getElementById('cancelEvent');
  const saveEvent = document.getElementById('saveEvent');
  const deleteEventBtn = document.getElementById('deleteEvent');

  const evtDate = document.getElementById('evtDate');
  const evtTime = document.getElementById('evtTime');
  const evtTitle = document.getElementById('evtTitle');
  const evtDesc = document.getElementById('evtDesc');
  const evtType = document.getElementById('evtType');
  const modalTitle = document.getElementById('modalTitle');

  // NEW: Day details refs
  const dd = document.getElementById('dayDetails');
  const ddTitle = document.getElementById('ddTitle');
  const ddBody = document.getElementById('ddBody');
  const ddClose = document.getElementById('ddClose');

  // ===== Type Colors + Enabled Set =====
  function typeColor(t){
    switch((t||'generic')){
      case 'xspace':  return '#000000';
      case 'youtube': return '#8B0000';
      case 'discord': return '#5865f2';
      case 'sabbath': return '#054A91';
      case 'newmoon': return '#81A4CD';
      case 'feast':   return '#F17300';
      default:        return '#054A91';
    }
  }
  const enabledTypes = new Set(['generic','xspace','youtube','discord','sabbath','newmoon','feast']);

  // ===== State / Storage =====
  const STORAGE_KEY = 'ir_events_v1';
  let events = loadEvents();
  let current = new Date();
  let editingId = null;

  function loadEvents(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch(e){ return []; }
  }
  function saveEvents(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
  }

  // ICS cache (read-only events)
  let icsEvents = [];

  // ===== Utils =====
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
  function pad(n){ return String(n).padStart(2,'0'); }
  function fmtDate(d){ return d instanceof Date
    ? `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
    : d; }
  function humanDate(d){ return new Date(d).toLocaleDateString(undefined,{weekday:'long', year:'numeric', month:'long', day:'numeric'}); }

  // Populate Month/Day/Year selects
  function populateSelectors(dateObj){
    // Month (0-11)
    selMonth.innerHTML = '';
    for(let m=0;m<12;m++){
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = new Date(2000, m, 1).toLocaleString(undefined,{month:'short'});
      if(m === dateObj.getMonth()) opt.selected = true;
      selMonth.appendChild(opt);
    }
    // Year (±5 around current year)
    const yearNow = new Date().getFullYear();
    const yrMin = yearNow - 5, yrMax = yearNow + 5;
    selYear.innerHTML = '';
    for(let y=yrMin; y<=yrMax; y++){
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if(y === dateObj.getFullYear()) opt.selected = true;
      selYear.appendChild(opt);
    }
    // Day (1..daysInMonth)
    const daysInMonth = new Date(dateObj.getFullYear(), dateObj.getMonth()+1, 0).getDate();
    selDay.innerHTML = '';
    for(let d=1; d<=daysInMonth; d++){
      const opt = document.createElement('option');
      opt.value = d; opt.textContent = d;
      if(d === dateObj.getDate()) opt.selected = true;
      selDay.appendChild(opt);
    }
  }
  function jumpToSelected(){
    const y = parseInt(selYear.value,10);
    const m = parseInt(selMonth.value,10);
       const d = parseInt(selDay.value,10);
    const maxD = new Date(y, m+1, 0).getDate();
    const safeD = Math.min(d || 1, maxD);
    current = new Date(y, m, safeD);
    render();
  }

  // ===== Day Details (additive; no visual changes elsewhere) =====
  function openDetails(dateStr){
    const items = events
      .filter(e => e.date === dateStr && enabledTypes.has(e.type || 'generic'))
      .sort((a,b)=> (a.time||'').localeCompare(b.time||''));
    ddTitle.textContent = humanDate(dateStr);
    ddBody.innerHTML = '';
    if(items.length === 0){
      const p = document.createElement('p');
      p.textContent = 'No events for this day.';
      p.style.color = '#555';
      ddBody.appendChild(p);
    } else {
      items.forEach(e=>{
        const card = document.createElement('div');
        card.className = 'dd-item';

        const line = document.createElement('div');
        line.className = 'dd-line';

        const dot = document.createElement('span');
        dot.className = 'dd-dot';
        dot.style.background = typeColor(e.type);

        const tm  = document.createElement('span');
        tm.className = 'dd-time';
        tm.textContent = e.time ? e.time : '—';

        const title = document.createElement('span');
        title.className = 'dd-title-txt';
        title.textContent = e.title;

        line.appendChild(dot);
        line.appendChild(document.createTextNode(" | "));
        line.appendChild(title);

        const notes = document.createElement('div');
        notes.className = 'dd-notes';
        notes.textContent = e.desc || '';

        card.appendChild(line);
        if(e.desc) card.appendChild(notes);

        ddBody.appendChild(card);
      });
    }
    dd.hidden = false;
  }
  function closeDetails(){ dd.hidden = true; }

  // ===== Render =====
  function render(){
    const first = startOfMonth(current);
    const last  = endOfMonth(current);
    const startDow = first.getDay();
    const totalDays = last.getDate();

    // keep selectors in sync
    populateSelectors(current);

    titleEl.textContent = first.toLocaleString(undefined, {month:'long', year:'numeric'});

    grid.innerHTML = '';

    // leading blanks
    for(let i=0;i<startDow;i++){
      const cell = document.createElement('div');
      cell.className = 'cal-cell cal-empty';
      grid.appendChild(cell);
    }

    const todayStr = fmtDate(new Date());

    for(let day=1; day<=totalDays; day++){
      const cell = document.createElement('div');
      cell.className = 'cal-cell';

      const dateObj = new Date(current.getFullYear(), current.getMonth(), day);
      const dateStr = fmtDate(dateObj);
      if(dateStr === todayStr) cell.classList.add('is-today');

      const dateEl = document.createElement('div');
      dateEl.className = 'cal-date';
      dateEl.textContent = day;
      /* OPEN DETAILS WHEN CLICKING THE DATE NUMBER (appearance unchanged) */
      dateEl.style.cursor = 'pointer';
      dateEl.title = 'View day details';
      dateEl.addEventListener('click', (ev)=>{ ev.stopPropagation(); openDetails(dateStr); });
      cell.appendChild(dateEl);

      // filter by enabled types
      const combined = [...events, ...icsEvents];
      const dayEvents = combined.filter(e =>
      e.date === dateStr &&
      enabledTypes.has(e.type || 'generic')
      );


      // chips: [dot] TIME — Title (unchanged behavior: click opens Edit)
      dayEvents.slice(0,3).forEach(e => {
        const chip = document.createElement('div');
        chip.className = 'evt-chip';

        const dot = document.createElement('span');
        dot.className = 'pill-dot';
        dot.style.background = typeColor(e.type);

        const text = document.createElement('span');
        text.textContent = e.time ? `${e.time} — ${e.title}` : e.title;

        chip.appendChild(dot);
        chip.appendChild(text);

        chip.title = e.desc || '';
        chip.addEventListener('click', (ev) => {
        ev.preventDefault();
        if (e.source === 'ics') {
        openDetails(dateStr); // view-only
        } else {
        openEdit(e);
        }
        });

        cell.appendChild(chip);
        });

      if(dayEvents.length > 3){
        const more = document.createElement('div');
        more.className = 'evt-chip';
        more.textContent = `+${dayEvents.length-3} more`;
        /* keep old behavior: +more opens Add */
        more.addEventListener('click', (ev)=>{ ev.preventDefault(); openAdd(dateStr); });
        cell.appendChild(more);
      }

      /* keep old behavior: empty area opens Add */
      cell.addEventListener('click', (ev)=>{
        if(ev.target.classList.contains('evt-chip') || ev.target.closest('.evt-chip')) return;
        if(ev.target.closest('.cal-date')) return; // date click handled above
        openAdd(dateStr);
      });

      grid.appendChild(cell);
    }
  }

  // ===== Modal logic =====
  function openAdd(dateStr){
    editingId = null;
    modalTitle.textContent = 'Add Event';
    evtDate.value = dateStr || fmtDate(new Date());
    evtTime.value = '';
    evtTitle.value = '';
    evtDesc.value = '';
    evtType.value = 'generic';
    deleteEventBtn.style.display = 'none';
    modal.classList.add('open');
    setTimeout(()=>evtTitle.focus(), 0);
  }

  function openEdit(e){
    editingId = e.id;
    modalTitle.textContent = 'Edit Event';
    evtDate.value = e.date;
    evtTime.value = e.time || '';
    evtTitle.value = e.title || '';
    evtDesc.value = e.desc || '';
    evtType.value = e.type || 'generic';
    deleteEventBtn.style.display = 'inline-block';
    modal.classList.add('open');
    setTimeout(()=>evtTitle.focus(), 0);
  }

  function close(){ modal.classList.remove('open'); }

  function onSave(){
    const date = evtDate.value;
    const title = evtTitle.value.trim();
    const time = evtTime.value.trim();
    const desc = evtDesc.value.trim();
    const type = evtType.value || 'generic';

    if(!date || !title){ alert('Please provide a date and title.'); return; }

    if(editingId){
      const idx = events.findIndex(x => x.id === editingId);
      if(idx >= 0){ events[idx] = { ...events[idx], date, title, time, desc, type }; }
    }else{
      const id = 'evt_' + Math.random().toString(36).slice(2,9);
      events.push({ id, date, title, time, desc, type });
    }
    saveEvents(); close(); render();
  }

  function onDelete(){
    if(!editingId) return;
    events = events.filter(x => x.id !== editingId);
    saveEvents(); close(); render();
  }

  // ===== Events =====
  addEventBtn.addEventListener('click', ()=> openAdd(fmtDate(new Date())));

  selMonth.addEventListener('change', jumpToSelected);
  selDay.addEventListener('change', jumpToSelected);
  selYear.addEventListener('change', jumpToSelected);

  closeModal.addEventListener('click', close);
  cancelEvent.addEventListener('click', close);
  deleteEventBtn.addEventListener('click', onDelete);
  saveEvent.addEventListener('click', onSave);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });

  // Legend toggles (unchanged)
  legend.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-type]');
    if(!btn) return;
    const t = btn.getAttribute('data-type');
    const pressed = btn.getAttribute('aria-pressed') === 'true';
    if(pressed){
      btn.setAttribute('aria-pressed','false');
      enabledTypes.delete(t);
    } else {
      btn.setAttribute('aria-pressed','true');
      enabledTypes.add(t);
    }
    render();
  });

  // Day details close
  ddClose.addEventListener('click', ()=>{ dd.hidden = true; });

  // Initial paint
    // Initial paint
  render();

  // Load ICS-expanded JSON (read-only)
  fetch('/israelite-research/assets/cal/basic.events.json', {cache:'no-store'})
    .then(r => r.ok ? r.json() : [])
    .then(arr => { icsEvents = Array.isArray(arr) ? arr : []; render(); })
    .catch(()=>{ /* quietly ignore if missing */ });


  /* ===================== NEW: Tabs & ICS renderer ===================== */
  const tabSite = document.getElementById('tabSite');
  const tabICS  = document.getElementById('tabICS');
  const sitePanel = document.getElementById('siteCalPanel');
  const icsPanel  = document.getElementById('icsPanel');
  // const tabGoogle = document.getElementById('tabGoogle');
  // const gcalPanel  = document.getElementById('gcalPanel');

  function setTab(which){
    const siteOn = which==='site';
    const icsOn  = which==='ics';
    tabSite.setAttribute('aria-pressed', siteOn ? 'true':'false');
    tabICS.setAttribute('aria-pressed',  icsOn  ? 'true':'false');
    sitePanel.classList.toggle('active', siteOn);
    icsPanel.classList.toggle('active',  icsOn);
    // if (tabGoogle) tabGoogle.setAttribute('aria-pressed', which==='gcal'?'true':'false');
    // if (gcalPanel)  gcalPanel.classList.toggle('active', which==='gcal');
  }
  tabSite.addEventListener('click', ()=> setTab('site'));
  tabICS.addEventListener('click',  ()=> { setTab('ics'); ensureICSLoaded(); });
  setTab('site');

  const ICS_URL = '/israelite-research/assets/cal/basic.ics';
  let icsLoaded = false;

  async function ensureICSLoaded(){
    if (icsLoaded) return;
    try{
      const txt = await fetch(ICS_URL, {cache:'no-store'}).then(r=>r.text());
      const events = parseICS(txt);
      const upcoming = expandAndFilter(events, 210); // ~7 months
      renderAgenda(upcoming);
      icsLoaded = true;
    }catch(e){
      document.getElementById('icsAgenda').innerHTML =
        '<div class="card"><div class="when" style="color:#b91c1c">Unable to load ICS file.</div></div>';
    }
  }

  function parseICS(text){
    const lines = text.replace(/\r\n/g,'\n').split('\n');
    const out = [];
    let cur = null;
    const flush = ()=>{ if(cur){ out.push(cur); cur=null; } };

    for (const raw of lines){
      if (raw==='BEGIN:VEVENT'){ cur={}; continue; }
      if (raw==='END:VEVENT'){ flush(); continue; }
      if (!cur) continue;
      const idx = raw.indexOf(':');
      if (idx<0) continue;
      const head = raw.slice(0,idx);
      const val  = raw.slice(idx+1);

      const key = head.split(';')[0].toUpperCase();
      if (key==='SUMMARY') cur.summary = val.trim();
      if (key==='UID')     cur.uid = val.trim();
      if (key==='DTSTART') cur.dtstart_raw = val.trim();
      if (key==='DTEND')   cur.dtend_raw   = val.trim();
      if (key==='RRULE'){
        const obj={}; val.split(';').forEach(p=>{ const [k,v]=p.split('='); obj[k]=v; });
        cur.rrule = obj;
      }
    }
    return out.map(normalizeEvent);
  }

  function parseDateYYYYMMDD(s){
    const y=+s.slice(0,4), m=+s.slice(4,6)-1, d=+s.slice(6,8);
    return new Date(Date.UTC(y,m,d));
  }

  function normalizeEvent(e){
    const start = parseDateYYYYMMDD(e.dtstart_raw);
    const end   = e.dtend_raw ? parseDateYYYYMMDD(e.dtend_raw) : new Date(start.getTime()+86400000);
    return {
      uid: e.uid || (e.summary||'')+(e.dtstart_raw||''),
      summary: e.summary || '(untitled)',
      start, end, allDay:true,
      rrule: e.rrule || null
    };
  }

  function expandAndFilter(events, horizonDays){
    const now = stripTime(new Date());
    const horizon = new Date(now.getTime()+horizonDays*86400000);
    const out = [];
    for (const ev of events){
      if (ev.rrule && ev.rrule.FREQ==='WEEKLY'){
        const days = (ev.rrule.BYDAY||'').split(',').filter(Boolean);
        const max = 40;
        for (const code of days){
          let cursor = nextWeekdayFrom(now, code);
          let n=0;
          while (cursor <= horizon && n<max){
            out.push({...ev, start:cursor, end:new Date(cursor.getTime()+86400000)});
            cursor = new Date(cursor.getTime()+7*86400000);
            n++;
          }
        }
      } else {
        if (ev.end > now) out.push(ev);
      }
    }
    out.sort((a,b)=> a.start - b.start);
    return out;
  }

  function stripTime(d){ return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); }
  function weekdayCodeToNum(code){ return {SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}[code] ?? 0; }
  function nextWeekdayFrom(base, code){
    const target = weekdayCodeToNum(code);
    const d = stripTime(base);
    const delta = (target - d.getUTCDay() + 7) % 7;
    d.setUTCDate(d.getUTCDate()+delta);
    return d;
  }

  function fmtRange(ev){
    const opts={month:'short',day:'numeric',timeZone:'UTC'};
    const oneDay=86400000;
    const same=(ev.end-ev.start)<=oneDay;
    if(same) return ev.start.toLocaleDateString(undefined,{...opts,year:'numeric'});
    const left  = ev.start.toLocaleDateString(undefined,{...opts,year:'numeric'});
    const right = new Date(ev.end-oneDay).toLocaleDateString(undefined,{...opts,year:'numeric'});
    return `${left} – ${right}`;
  }

  function renderAgenda(events){
    const host = document.getElementById('icsAgenda');
    host.innerHTML='';
    if (!events.length){
      host.innerHTML = '<div class="card"><div class="when">No upcoming events.</div></div>';
      return;
    }
    for (const ev of events.slice(0,100)){
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<h3>${escapeHTML(ev.summary)}</h3><div class="when">${fmtRange(ev)}</div>`;
      host.appendChild(el);
    }
  }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
})();
</script>
</body>
</html>
