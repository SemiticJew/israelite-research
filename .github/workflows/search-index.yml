name: Build search-index
on:
  push:
    branches: [ "main" ]
    paths:
      - "articles/**"
      - "encyclopedia/**"
      - "regions/**"
      - "pages/**"
      - "*.html"
      - "tools/build_search_index.py"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Build search index
        run: |
          python3 tools/build_search_index.py --root . --out search-index.json
      - name: Commit search-index.json
        run: |
          if [[ -n "$(git status --porcelain search-index.json)" ]]; then
            git config user.name "github-actions"
            git config user.email "github-actions@users.noreply.github.com"
            git add search-index.json
            git commit -m "CI: rebuild search-index.json"
          fi
      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
