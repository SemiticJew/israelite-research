<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources — amCharts Map</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340}
  html,body{height:100%;margin:0;background:#fff;color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
  .toolbar{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #eef2f7;flex-wrap:wrap}
  select{border:1px solid #cfd8e3;border-radius:10px;padding:.45rem .6rem;background:#fff;font:inherit}
  #chartdiv{width:100%;height:72vh;min-height:420px}
  .legend{position:absolute;right:14px;top:68px;background:#fff;border:1px solid #e6ebf2;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:8px 10px;display:none}
  .legend h4{margin:.2rem 0 .4rem;font-size:.9rem;color:#054A91}
  .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
  .legend .swatch{width:14px;height:14px;border-radius:3px;border:1px solid #cbd5e1}
  .legend.show{display:block}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container" style="position:relative">
  <h1 class="page-title">Interactive Map (amCharts v5)</h1>
  <section class="card">
    <div class="toolbar">
      <label for="mapSelect"><strong>View:</strong></label>
      <select id="mapSelect">
        <option value="africaME">Africa + Middle East</option>
        <option value="ancient" selected>Ancient Israel (schematic)</option>
      </select>
    </div>
    <div id="chartdiv"></div>
  </section>
  <div id="legend" class="legend" aria-live="polite"></div>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/africaLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/middleEastLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<script>
am5.ready(function() {
  let root, chart, zoomControl;
  const legendEl = document.getElementById("legend");

  function disposeAll() {
    if (root) { root.dispose(); root = null; }
    legendEl.classList.remove('show');
    legendEl.innerHTML = '';
  }

  function styleSeries(series, root) {
    series.mapPolygons.template.setAll({
      tooltipText: "{name}",
      toggleKey: "active",
      interactive: true,
      fill: am5.color("#f4ede1"),
      stroke: am5.color("#c4b79c"),
      strokeOpacity: 1,
      strokeWidth: 0.8
    });
    series.mapPolygons.template.states.create("hover",  { fill: am5.color("#fcd34d") });
    series.mapPolygons.template.states.create("active", { fill: am5.color("#b45309") });
  }

  // landmask for ancient view: add clearer coastline hint
  function styleLandmask(series) {
    series.mapPolygons.template.setAll({
      fill: am5.color("#f4ede1"),
      fillOpacity: 0.22,
      stroke: am5.color("#8f7a61"),
      strokeOpacity: 0.35,
      strokeWidth: 0.8,
      interactive: false,
      tooltipText: ""
    });
  }

  function addWaterLayer(chart, root) {
    const waterSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
    waterSeries.mapPolygons.template.setAll({
      fill: am5.color("#bcdcff"),
      fillOpacity: 0.95,
      stroke: am5.color("#6f95b8"),
      strokeOpacity: 0.95,
      strokeWidth: 0.9,
      interactive: false,
      tooltipText: "{name}"
    });
    fetch("data/maps/ancient-water.geojson?v=" + Date.now())
      .then(r => r.json())
      .then(geo => waterSeries.setAll({ geoJSON: geo }))
      .catch(err => console.error("water load error", err));
  }

  function addAncientOverlay(chart, root) {
    const ancientSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
    ancientSeries.mapPolygons.template.setAll({
      tooltipText: "{name} — {period}",
      interactive: true,
      fillOpacity: 0.6,
      strokeOpacity: 1,
      strokeWidth: 1.4
    });
    ancientSeries.mapPolygons.template.states.create("hover",  { fillOpacity: 0.82 });
    ancientSeries.mapPolygons.template.states.create("active", { fill: am5.color("#b45309"), fillOpacity: 0.95 });

    ancientSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
      const dc = target.dataItem && target.dataItem.dataContext;
      const col = dc && dc.properties && dc.properties.fill;
      return col ? am5.color(col) : am5.color("#bcbcbc");
    });
    ancientSeries.mapPolygons.template.adapters.add("stroke", (stroke, target) => {
      const dc = target.dataItem && target.dataItem.dataContext;
      const col = dc && dc.properties && dc.properties.stroke;
      return col ? am5.color(col) : am5.color("#333333");
    });

    fetch("data/maps/ancient-israel.geojson?v=" + Date.now())
      .then(r => r.json())
      .then(geo => {
        ancientSeries.setAll({ geoJSON: geo });
        const rows = (geo.features || []).map(f => {
          const n = (f.properties && f.properties.name) || "Region";
          const c = (f.properties && f.properties.fill) || "#cccccc";
          return `<div class="row"><span class="swatch" style="background:${c}"></span>${n}</div>`;
        }).join("");
        legendEl.innerHTML = `<h4>Ancient Regions</h4>${rows}`;
        legendEl.classList.add('show');
      })
      .catch(err => console.error("ancient borders load error", err));
  }

  function makeMap(view) {
    disposeAll();

    root = am5.Root.new("chartdiv");
    root.setThemes([ am5themes_Animated.new(root) ]);

    // set initial framing for ancient view (not an auto-zoom; defines home view)
    const isAncient = (view === "ancient");
    const initialBounds = isAncient
      ? { north: 34.4, south: 30.0, west: 33.6, east: 37.0 }  // Levant frame
      : undefined;

    chart = root.container.children.push(am5map.MapChart.new(root, {
      panX: "rotateX",
      panY: "translateY",
      projection: am5map.geoNaturalEarth1(),
      homeGeoBounds: initialBounds
    }));
    chart.chartContainer.set("background", am5.Rectangle.new(root, { fill: am5.color("#e0f2ff") }));

    if (view === "africaME") {
      const africaSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_africaLow
      }));
      const meSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_middleEastLow
      }));
      styleSeries(africaSeries, root);
      styleSeries(meSeries, root);
    } else if (isAncient) {
      const landAfrica = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_africaLow
      }));
      const landME = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_middleEastLow
      }));
      styleLandmask(landAfrica);
      styleLandmask(landME);
      addWaterLayer(chart, root);
      addAncientOverlay(chart, root);
    }

    zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
    zoomControl.homeButton.set("visible", true);
    zoomControl.homeButton.events.on("click", function() { chart.goHome(); });
    chart.chartContainer.get("background").events.on("click", function() { chart.goHome(); });

    chart.appear(600, 100);
    if (isAncient) chart.goHome(); // use the Levant frame on load
  }

  const select = document.getElementById("mapSelect");
  makeMap(select.value);
  select.addEventListener("change", () => makeMap(select.value));
});
</script>
</body>
</html>
