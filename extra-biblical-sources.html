<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources — Map (Linked JSON)</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340}
  html,body{height:100%;margin:0;background:#fff;color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
  #chartdiv{width:100%;height:72vh;min-height:420px}
  .status{margin-top:10px;border:1px dashed #cbd5e1;border-radius:10px;padding:10px;color:#334155;background:#f8fafc}
  .status b{color:#0b2340}
  .status .bad{color:#b91c1c}
  .status .ok{color:#065f46}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <h1 class="page-title">Africa + Middle East Map</h1>
  <section class="card">
    <div id="chartdiv"></div>
  </section>

  <div class="status">
    <b>Source:</b> ancient.json + geometry.json<br>
    <b>Status:</b> <span id="map-status">Loading…</span>
  </div>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/africaLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/middleEastLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<script>
am5.ready(async function() {
  const status = document.getElementById("map-status");
  const setStatus = (t,c)=>{status.textContent=t;status.className=c||"";}

  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);
  var chart = root.container.children.push(am5map.MapChart.new(root, {
    panX: "rotateX", panY: "translateY",
    projection: am5map.geoNaturalEarth1()
  }));
  chart.chartContainer.set("background", am5.Rectangle.new(root,{fill:am5.color("#e0f2ff")}));

  const africa = chart.series.push(am5map.MapPolygonSeries.new(root,{geoJSON:am5geodata_region_world_africaLow}));
  const me = chart.series.push(am5map.MapPolygonSeries.new(root,{geoJSON:am5geodata_region_world_middleEastLow}));
  const style = s=>s.mapPolygons.template.setAll({fill:am5.color("#f4ede1"),stroke:am5.color("#c4b79c"),strokeWidth:0.8});
  style(africa);style(me);

  try {
    const [geom,recs]=await Promise.all([
      fetch("data/geometry.json?v="+Date.now()).then(r=>r.json()),
      fetch("data/ancient.json?v="+Date.now()).then(r=>r.json())
    ]);
    if(!Array.isArray(geom)||!Array.isArray(recs)) throw new Error("Invalid JSON data");
    const gById=new Map(geom.map(g=>[String(g.id),g]));
    const poly=[],lines=[],pts=[];
    for(const r of recs){
      const g=gById.get(String(r.geometry_id)); if(!g) continue;
      const coords=g.lonlat||g.points||g.coordinates;
      const type=(g.type||"").toLowerCase();
      const props={name:r.title||r.id,period:r.period||"",blurb:r.blurb||""};
      if(type.includes("poly")) poly.push({type:"Feature",properties:props,geometry:{type:"Polygon",coordinates:[coords]}});
      else if(type.includes("line")) lines.push({type:"Feature",properties:props,geometry:{type:"LineString",coordinates:coords}});
      else if(type.includes("point")&&coords&&coords.length)
        pts.push({longitude:coords[0][0],latitude:coords[0][1],title:props.name,subtitle:props.period});
    }
    const regions=chart.series.push(am5map.MapPolygonSeries.new(root,{}));
    regions.mapPolygons.template.setAll({tooltipText:"{name}\n{period}\n{blurb}",interactive:true,fillOpacity:0.55});
    regions.setAll({geoJSON:{type:"FeatureCollection",features:poly}});
    const routes=chart.series.push(am5map.MapLineSeries.new(root,{}));
    routes.mapLines.template.setAll({stroke:am5.color("#8b5e34"),strokeWidth:1.5,tooltipText:"{name}"});
    routes.setAll({geoJSON:{type:"FeatureCollection",features:lines}});
    const points=chart.series.push(am5map.MapPointSeries.new(root,{longitudeField:"longitude",latitudeField:"latitude"}));
    points.bullets.push(()=>am5.Bullet.new(root,{sprite:am5.Circle.new(root,{radius:4,fill:am5.color("#b91c1c"),tooltipText:"{title}\n{subtitle}"})}));
    points.data.setAll(pts);
    setStatus(`Loaded ${poly.length} polygons, ${lines.length} lines, ${pts.length} points`,"ok");
  }catch(e){
    console.error(e);
    setStatus(e.message||"Error loading data","bad");
  }

  var zoom=chart.set("zoomControl",am5map.ZoomControl.new(root,{}));
  zoom.homeButton.set("visible",true);
  zoom.homeButton.events.on("click",()=>chart.goHome());
});
</script>
</body>
</html>
