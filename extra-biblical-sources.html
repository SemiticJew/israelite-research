<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources — Global Map</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340;--muted:#64748b;--sky:#e6ebf2;--panel:#ffffff;--shadow:rgba(2,6,23,.15)}
  html,body{height:100%;margin:0;color:var(--ink);background:#fff;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px var(--shadow);overflow:hidden}
  .mapwrap{width:100%;height:80vh;min-height:520px}
  .muted{color:var(--muted)}

  /* Drawer */
  .drawer{position:fixed;top:0;right:0;height:100vh;width:min(420px,92vw);background:var(--panel);
          border-left:1px solid #e5e7eb;box-shadow:-12px 0 32px var(--shadow);transform:translateX(100%);
          transition:transform .28s ease;z-index:9999;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .drawer-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
  .drawer-title{margin:0;font-size:1.1rem;font-weight:800}
  .drawer-body{padding:14px 16px;overflow:auto}
  .ref{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;margin:8px 0;background:#fafafa}
  .ref b{display:block;margin-bottom:4px}
  .drawer-actions{display:flex;gap:8px;align-items:center;padding:8px 16px 14px;border-top:1px solid #eef2f7}
  .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.primary{background:#0b2340;color:#fff;border-color:#0b2340}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{font-size:.78rem;background:#eef2f7;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px}
  @media (max-width: 640px){ .mapwrap{height:70vh;min-height:420px} }
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <h1 class="page-title">Interactive Global Map</h1>
  <div class="card"><div id="chart-globe" class="mapwrap" aria-label="Interactive global map"></div></div>
  <p class="muted" style="margin:.6rem 0 0">Hover a country for a quick note. Click to open the Bible references panel.</p>
</main>

<div id="site-footer"></div>

<!-- Drawer -->
<aside id="drawer" class="drawer" aria-hidden="true" aria-labelledby="drawer-title" role="dialog">
  <div class="drawer-header">
    <h2 id="drawer-title" class="drawer-title">Region</h2>
    <div class="row">
      <button id="copy-link" class="btn" title="Copy shareable link">Copy link</button>
      <button id="drawer-close" class="btn primary" aria-label="Close panel">Close</button>
    </div>
  </div>
  <div id="drawer-body" class="drawer-body">
    <!-- Populated dynamically -->
  </div>
  <div class="drawer-actions">
    <div class="row"><span class="tag" id="drawer-region-id">—</span></div>
  </div>
</aside>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>

<script>
let REGION_NOTES = null;
async function getRegionNotes(){
  if (REGION_NOTES) return REGION_NOTES;
  try{
    const r = await fetch("data/region-notes.json?v="+Date.now(), { cache:"no-store" });
    REGION_NOTES = await r.json();
  }catch(e){
    REGION_NOTES = {};
  }
  return REGION_NOTES;
}

function openDrawer(payload){
  const drawer = document.getElementById('drawer');
  const body   = document.getElementById('drawer-body');
  const title  = document.getElementById('drawer-title');
  const tag    = document.getElementById('drawer-region-id');

  title.textContent = payload.title || payload.name || 'Region';
  tag.textContent   = payload.id || '—';

  const refs = Array.isArray(payload.refs) ? payload.refs : [];
  body.innerHTML = '';
  if (payload.summary){
    const p = document.createElement('p');
    p.textContent = payload.summary;
    p.style.marginBottom = '8px';
    body.appendChild(p);
  }
  if (refs.length){
    refs.forEach(r=>{
      const div=document.createElement('div');
      div.className='ref';
      const b=document.createElement('b');
      b.textContent = r.verse || '';
      const p=document.createElement('p');
      p.style.margin='0';
      p.textContent = r.note || '';
      div.appendChild(b);
      div.appendChild(p);
      body.appendChild(div);
    });
  } else {
    const p=document.createElement('p');
    p.className='muted';
    p.textContent='No references added yet for this region.';
    body.appendChild(p);
  }

  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden','false');
}

function closeDrawer(){
  const drawer = document.getElementById('drawer');
  drawer.classList.remove('open');
  drawer.setAttribute('aria-hidden','true');
}

function updateShareLink(id){
  const url = new URL(window.location.href);
  if (id) url.searchParams.set('region', id); else url.searchParams.delete('region');
  history.replaceState(null,'',url.toString());
}

function hydrateFromURL(worldSeries){
  const url = new URL(window.location.href);
  const rid = url.searchParams.get('region');
  if (!rid) return;
  const notes = REGION_NOTES || {};
  const hit = notes[rid];
  if (!hit) return;
  // try to find polygon by id and set active state
  worldSeries.mapPolygons.each(mp=>{
    const ctx = mp.dataItem?.dataContext || {};
    const id  = ctx.id || ctx.iso_a2 || ctx.code || null;
    if (id === rid){
      mp.set('active', true);
    } else {
      mp.set('active', false);
    }
  });
  openDrawer({ id: rid, title: hit.title, summary: hit.summary, refs: hit.refs });
}

am5.ready(async function(){
  const root = am5.Root.new("chart-globe");
  root.setThemes([am5themes_Animated.new(root)]);

  const chart = root.container.children.push(am5map.MapChart.new(root,{
    panX:"rotateX",
    panY:"rotateY",
    projection:am5map.geoOrthographic()
  }));

  chart.chartContainer.set("background", am5.Rectangle.new(root, { fill: am5.color("#e0f2ff") }));

  const world = chart.series.push(am5map.MapPolygonSeries.new(root,{ geoJSON: am5geodata_worldLow, exclude:["AQ"] }));

  world.mapPolygons.template.setAll({
    tooltipText: "{name}",
    interactive: true,
    toggleKey: "active",
    fill: root.interfaceColors.get("background"),
    stroke: am5.color("#c4b79c"),
    strokeWidth: 0.8
  });
  world.mapPolygons.template.states.create("hover",  { fill: am5.color("#fcd34d") });
  world.mapPolygons.template.states.create("active", { fill: am5.color("#b45309") });

  const zoom = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
  zoom.homeButton.set("visible", true);
  zoom.homeButton.events.on("click", () => chart.goHome());

  const NOTES = await getRegionNotes();

  // Tooltip: short summary on hover
  world.mapPolygons.template.adapters.add("tooltipText", function(def, target){
    const ctx = target.dataItem?.dataContext || {};
    const id  = ctx.id || ctx.iso_a2 || ctx.code || null;
    const hit = id && NOTES[id];
    if (hit){
      const line = (hit.summary || (hit.refs && hit.refs[0]?.note) || "").slice(0,120);
      const title = hit.title || ctx.name || "{name}";
      return line ? `${title}\n• ${line}` : `${title}`;
    }
    return "{name}";
  });

  // Click: open drawer with full references
  world.mapPolygons.template.events.on("click", ev=>{
    const ctx = ev.target.dataItem?.dataContext || {};
    const id  = ctx.id || ctx.iso_a2 || ctx.code || null;
    const hit = id && NOTES[id];
    if (id){
      updateShareLink(id);
      // set states
      world.mapPolygons.each(mp => mp.set('active', mp === ev.target));
      if (hit){
        openDrawer({ id, title: hit.title, summary: hit.summary, refs: hit.refs });
      } else {
        openDrawer({ id, title: ctx.name || id, summary: null, refs: [] });
      }
    }
  });

  // Drawer controls
  document.getElementById('drawer-close').addEventListener('click', ()=>{
    updateShareLink(null);
    world.mapPolygons.each(mp => mp.set('active', false));
    closeDrawer();
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') {
      updateShareLink(null);
      world.mapPolygons.each(mp => mp.set('active', false));
      closeDrawer();
    }
  });
  document.getElementById('copy-link').addEventListener('click', async ()=>{
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied!');
    } catch(e){ alert('Could not copy link'); }
  });

  // If URL has ?region=XX, hydrate
  hydrateFromURL(world);
});
</script>
</body>
</html>
