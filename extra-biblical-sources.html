<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources — Global Map</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340;--muted:#64748b;--sky:#e6ebf2}
  html,body{height:100%;margin:0;color:var(--ink);background:#fff;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,.12);overflow:hidden}
  .mapwrap{width:100%;height:80vh;min-height:500px}
  .muted{color:var(--muted)}
  .status{margin-top:10px;border:1px dashed #cbd5e1;border-radius:10px;padding:8px 10px;color:#334155;background:#f8fafc}
  .status b{color:#0b2340}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <h1 class="page-title">Interactive Global Map</h1>
  <div class="card"><div id="chart-globe" class="mapwrap"></div></div>
  <div class="status">
    <b>Notes:</b> <span id="note-status">loading…</span> ·
    <b>Keys:</b> <span id="note-keys">0</span> ·
    <b>Matched Regions:</b> <span id="note-matched">0</span> ·
    <b>Total Regions:</b> <span id="total-regions">0</span> ·
    <b>Sample IDs:</b> <span id="sample-ids">—</span>
  </div>
  <p class="muted" style="margin:.5rem 0 0">Hover a highlighted country for the quick line from region-notes.json.</p>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>

<script>
const $ = (id)=>document.getElementById(id);
const noteStatusEl = $("note-status");
const noteKeysEl   = $("note-keys");
const noteMatchEl  = $("note-matched");
const totalRegionsEl = $("total-regions");
const sampleIdsEl  = $("sample-ids");

async function getRegionNotes(){
  try{
    const r = await fetch("data/region-notes.json?v="+Date.now(), { cache:"no-store" });
    if (!r.ok) throw new Error("HTTP "+r.status);
    const json = await r.json();
    return (json && typeof json === "object") ? json : {};
  }catch(e){
    console.error("Failed to load region-notes.json", e);
    return {};
  }
}

am5.ready(async function(){
  const root = am5.Root.new("chart-globe");
  root.setThemes([am5themes_Animated.new(root)]);

  const chart = root.container.children.push(am5map.MapChart.new(root,{
    panX:"rotateX",
    panY:"rotateY",
    projection:am5map.geoOrthographic()
  }));
  chart.chartContainer.set("background", am5.Rectangle.new(root, { fill: am5.color("#e0f2ff") }));

  const world = chart.series.push(am5map.MapPolygonSeries.new(root,{ geoJSON: am5geodata_worldLow, exclude:["AQ"] }));
  world.mapPolygons.template.setAll({
    tooltipText: "{name}",
    interactive: true,
    fill: root.interfaceColors.get("background"),
    stroke: am5.color("#c4b79c"),
    strokeWidth: 0.8
  });
  world.mapPolygons.template.states.create("hover",  { fill: am5.color("#fcd34d") });

  const zoom = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
  zoom.homeButton.set("visible", true);
  zoom.homeButton.events.on("click", () => chart.goHome());

  const NOTES = await getRegionNotes();
  const keys = Object.keys(NOTES);
  noteKeysEl.textContent = String(keys.length);
  noteStatusEl.textContent = keys.length ? "loaded" : "empty";

  const NAME_INDEX = {};
  for (const k of keys){
    const v = NOTES[k];
    if (v && v.title) NAME_INDEX[String(v.title).trim().toUpperCase()] = v;
  }

  function polyCode(mp){
    const di  = mp?.dataItem;
    const ctx = di?.dataContext || {};
    // Try several places for the ID
    const a = (ctx.id || ctx.iso_a2 || ctx.iso2 || ctx.code || ctx.iso_a3 || "").toString().trim();
    const b = (typeof di?.get === "function" ? (di.get("id") || "") : "").toString().trim();
    const c = (typeof mp.get === "function" ? (mp.get("id") || "") : "").toString().trim();
    return (a || b || c).toUpperCase();
  }
  function polyName(mp){
    const ctx = mp?.dataItem?.dataContext || {};
    return (ctx.name || "").toString().trim();
  }

  // Core: compute totals, sample IDs, and mark matches
  function computeDiagnostics(){
    let total = 0, matched = 0;
    const samples = [];
    world.mapPolygons.each(mp=>{
      total++;
      const code = polyCode(mp);
      const name = polyName(mp);
      if (samples.length < 10) samples.push(code || "(no-id)");
      const hit  = (code && NOTES[code]) || (name && NAME_INDEX[name.toUpperCase()]);
      if (hit){
        matched++;
        mp.setAll({ stroke: am5.color("#0b2340"), strokeWidth: 1.2 });
      }
    });
    totalRegionsEl.textContent = String(total);
    sampleIdsEl.textContent = samples.join(", ");
    noteMatchEl.textContent = String(matched);
  }

  // Run on datavalidated and also once after a short delay
  world.events.on("datavalidated", computeDiagnostics);
  setTimeout(computeDiagnostics, 1200);

  // Tooltip with code/name fallback
  world.mapPolygons.template.adapters.add("tooltipText", function(def, target){
    const code = polyCode(target);
    const name = polyName(target);
    const hit  = (code && NOTES[code]) || (name && NAME_INDEX[name.toUpperCase()]);
    if (hit){
      const title = hit.title || name || "{name}";
      const line  = (hit.summary || (hit.refs && hit.refs[0]?.note) || "").slice(0,120);
      return line ? `${title}\n• ${line}` : `${title}`;
    }
    return "{name}";
  });
});
</script>
</body>
</html>
