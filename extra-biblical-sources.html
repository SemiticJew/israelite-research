<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources — Global Map</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>

<style>
  :root{--ink:#0b2340;--muted:#64748b;--sky:#e6ebf2}
  html,body{height:100%;margin:0;color:var(--ink);background:#fff;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
  .mapwrap{width:100%;height:80vh;min-height:500px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <h1 class="page-title">Interactive Global Map</h1>
  <div class="card"><div id="chart-globe" class="mapwrap"></div></div>
  <p class="muted" style="margin:.5rem 0 0">Hover a country to view biblical references related to that region.</p>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>

<script>
let REGION_NOTES = null;
async function getRegionNotes(){
  if(REGION_NOTES) return REGION_NOTES;
  try{
    const r = await fetch("data/region-notes.json?v="+Date.now(), {cache:"no-store"});
    REGION_NOTES = await r.json();
  }catch(e){ REGION_NOTES = {}; }
  return REGION_NOTES;
}

async function attachRegionNotes(series){
  const NOTES = await getRegionNotes();
  series.events.on("datavalidated", ()=>{
    series.mapPolygons.each(mp=>{
      const ctx = mp.dataItem?.dataContext || {};
      const id  = ctx.id || ctx.iso_a2 || ctx.code || null;
      const hit = id && NOTES[id];
      if(hit){
        const lines = (hit.refs||[]).map(r=>`• ${r.verse} — ${r.note}`).join("\n");
        mp.dataItem.set("tooltipText", `${hit.title || ctx.name || "{name}"}\n${lines}`);
      } else {
        mp.dataItem.set("tooltipText", "{name}");
      }
    });
  });
}

am5.ready(async function(){
  const root = am5.Root.new("chart-globe");
  root.setThemes([am5themes_Animated.new(root)]);

  const chart = root.container.children.push(am5map.MapChart.new(root,{
    panX:"rotateX",
    panY:"rotateY",
    projection:am5map.geoOrthographic()
  }));

  chart.chartContainer.set("background", am5.Rectangle.new(root, { fill: am5.color("#e0f2ff") }));

  const world = chart.series.push(am5map.MapPolygonSeries.new(root,{ geoJSON: am5geodata_worldLow, exclude:["AQ"] }));

  world.mapPolygons.template.setAll({
    tooltipText: "{name}",
    interactive: true,
    fill: root.interfaceColors.get("background"),
    stroke: am5.color("#c4b79c"),
    strokeWidth: 0.8
  });

  world.mapPolygons.template.states.create("hover", { fill: am5.color("#fcd34d") });

  const zoom = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
  zoom.homeButton.set("visible", true);
  zoom.homeButton.events.on("click", () => chart.goHome());

  await attachRegionNotes(world);
});
</script>
</body>
</html>
