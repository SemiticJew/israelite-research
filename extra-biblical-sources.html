<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources â€” amCharts Map</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340;--brand:#054A91;--muted:#6b7280}
  html,body{height:100%;margin:0;background:#fff;color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
  .toolbar{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #eef2f7;flex-wrap:wrap}
  select{border:1px solid #cfd8e3;border-radius:10px;padding:.45rem .6rem;background:#fff;font:inherit}
  #chartdiv{width:100%;height:72vh;min-height:420px}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <h1 class="page-title">Interactive Map (amCharts v5)</h1>
  <section class="card">
    <div class="toolbar">
      <label for="mapSelect"><strong>View:</strong></label>
      <select id="mapSelect">
        <option value="world">World</option>
        <option value="middleEast" selected>Middle East</option>
      </select>
    </div>
    <div id="chartdiv"></div>
  </section>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/middleEastLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<script>
am5.ready(function() {
  let root, chart, polygonSeries, zoomControl, eventsSeries;

  function disposeAll() {
    if (root) { root.dispose(); root = null; }
  }

  function makeMap(view) {
    disposeAll();

    root = am5.Root.new("chartdiv");
    root.setThemes([ am5themes_Animated.new(root) ]);

    chart = root.container.children.push(am5map.MapChart.new(root, {
      panX: "rotateX",
      panY: "translateY",
      projection: am5map.geoNaturalEarth1()
    }));

    chart.chartContainer.set("background", am5.Rectangle.new(root, { fill: am5.color("#e0f2ff") }));

    const seriesCfg = {};
    if (view === "middleEast") {
      seriesCfg.geoJSON = am5geodata_region_world_middleEastLow;
    } else {
      seriesCfg.geoJSON = am5geodata_worldLow;
      seriesCfg.exclude = ["AQ"];
    }

    polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, seriesCfg));

    polygonSeries.mapPolygons.template.setAll({
      tooltipText: "{name}",
      toggleKey: "active",
      interactive: true,
      fill: am5.color("#f4ede1"),
      stroke: am5.color("#c4b79c"),
      strokeOpacity: 1,
      strokeWidth: 0.8
    });

    polygonSeries.mapPolygons.template.states.create("hover", { fill: am5.color("#fcd34d") });
    polygonSeries.mapPolygons.template.states.create("active", { fill: am5.color("#b45309") });

    zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
    zoomControl.homeButton.set("visible", true);
    zoomControl.homeButton.events.on("click", function() { chart.goHome(); });

    chart.chartContainer.get("background").events.on("click", function() { chart.goHome(); });

    chart.appear(600, 100);

    if (view === "middleEast") {
      
    }

    eventsSeries = chart.series.push(am5map.MapPointSeries.new(root, {
      valueField: "value",
      longitudeField: "lon",
      latitudeField: "lat"
    }));

    const ICON_SRC = {
      covenant: "assets/icons/covenant.svg",
      exodus: "assets/icons/exodus.svg",
      miracle: "assets/icons/miracle.svg",
      generic: "assets/icons/generic.svg"
    };

    eventsSeries.bullets.push(() => {
      return am5.Bullet.new(root, {
        sprite: am5.Picture.new(root, {
          width: 18, height: 18,
          centerX: am5.p50, centerY: am5.p50,
          src: "assets/icons/generic.svg",
          tooltipText: "{title}\n{subtitle}"
        })
      });
    });

    eventsSeries.bulletsContainer.events.on("boundschanged", () => {
      eventsSeries.bulletsContainer.children.each(pic => {
        const d = pic.dataItem && pic.dataItem.dataContext ? pic.dataItem.dataContext : {};
        const src = (d && d.icon) ? d.icon : (ICONSRC(d && d.type) || ICON_SRC.generic);
        if (pic.set) pic.set("src", src);
      });
    });

    function ICONSRC(t){ return ICON_SRC[t] || null; }

    eventsSeries.set("clustered", true);
    eventsSeries.set("clusteredSettings", {
      text: "{count}",
      fill: am5.color("#fcd34d"),
      stroke: am5.color("#b45309")
    });

    eventsSeries.bulletsContainer.events.on("click", ev => {
      const d = ev.target && ev.target.dataItem ? ev.target.dataItem.dataContext : null;
      if (!d) return;
      console.log("Event clicked:", d);
    });

    fetch("data/events.json?v=" + Date.now())
      .then(r => r.json())
      .then(data => eventsSeries.data.setAll(data))
      .catch(err => console.error("events load error", err));
  }

  const select = document.getElementById("mapSelect");
  makeMap(select.value);
  select.addEventListener("change", () => makeMap(select.value));
});
</script>
</body>
</html>
