<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Extra-Biblical Sources — amCharts Map</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340;--brand:#054A91;--muted:#6b7280}
  html,body{height:100%;margin:0;background:#fff;color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .page-title{margin:.2rem 0 1rem;font-size:1.6rem;font-weight:800}
  .card{background:#fff;border:1px solid #e6ebf2;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
  .toolbar{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #eef2f7;flex-wrap:wrap}
  select{border:1px solid #cfd8e3;border-radius:10px;padding:.45rem .6rem;background:#fff;font:inherit}
  #chartdiv{width:100%;height:72vh;min-height:420px}
  .legend{position:absolute;right:14px;top:68px;background:#fff;border:1px solid #e6ebf2;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:8px 10px;display:none}
  .legend h4{margin:.2rem 0 .4rem;font-size:.9rem;color:#054A91}
  .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
  .legend .swatch{width:14px;height:14px;border-radius:3px;border:1px solid #cbd5e1}
  .legend.show{display:block}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container" style="position:relative">
  <h1 class="page-title">Interactive Map (amCharts v5)</h1>
  <section class="card">
    <div class="toolbar">
      <label for="mapSelect"><strong>View:</strong></label>
      <select id="mapSelect">
        <option value="world">World</option>
        <option value="middleEast">Middle East</option>
        <option value="africaME">Africa + Middle East</option>
        <option value="ancient">Ancient Israel (schematic)</option>
      </select>
    </div>
    <div id="chartdiv"></div>
  </section>
  <div id="legend" class="legend" aria-live="polite"></div>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/shims.js" defer></script>
<script src="/israelite-research/js/include.js" defer></script>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/middleEastLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/region/world/africaLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<script>
am5.ready(function() {
  let root, chart, zoomControl;

  const legendEl = document.getElementById("legend");

  function disposeAll() {
    if (root) { root.dispose(); root = null; }
    legendEl.classList.remove('show');
    legendEl.innerHTML = '';
  }

  // Earth-toned style (shared)
  function styleSeries(series, root) {
    series.mapPolygons.template.setAll({
      tooltipText: "{name}",
      toggleKey: "active",
      interactive: true,
      fill: am5.color("#f4ede1"),      // parchment land
      stroke: am5.color("#c4b79c"),    // warm borders
      strokeOpacity: 1,
      strokeWidth: 0.8
    });
    series.mapPolygons.template.states.create("hover",  { fill: am5.color("#fcd34d") }); // golden hover
    series.mapPolygons.template.states.create("active", { fill: am5.color("#b45309") }); // bronze active
  }

  function styleFaint(series) {
    // faint base so Ancient looks like other maps but keeps focus on ancient regions
    series.mapPolygons.template.setAll({
      fill: am5.color("#f4ede1"),
      fillOpacity: 0.18,
      stroke: am5.color("#c4b79c"),
      strokeOpacity: 0.35,
      strokeWidth: 0.6,
      tooltipText: "{name}",
      interactive: false
    });
  }

  function addEventsLayer(chart, root) {
    const eventsSeries = chart.series.push(am5map.MapPointSeries.new(root, {
      valueField: "value",
      longitudeField: "lon",
      latitudeField: "lat"
    }));

    const ICON_SRC = {
      covenant: "assets/icons/covenant.svg",
      exodus:   "assets/icons/exodus.svg",
      miracle:  "assets/icons/miracle.svg",
      generic:  "assets/icons/generic.svg"
    };

    eventsSeries.bullets.push(() => {
      return am5.Bullet.new(root, {
        sprite: am5.Picture.new(root, {
          width: 18, height: 18,
          centerX: am5.p50, centerY: am5.p50,
          src: ICON_SRC.generic,
          tooltipText: "{title}\n{subtitle}"
        })
      });
    });

    eventsSeries.bulletsContainer.events.on("boundschanged", () => {
      eventsSeries.bulletsContainer.children.each(pic => {
        const d = pic.dataItem && pic.dataItem.dataContext ? pic.dataItem.dataContext : {};
        const src = (d && d.icon) ? d.icon : (ICON_SRC[d && d.type] || ICON_SRC.generic);
        if (pic.set) pic.set("src", src);
      });
    });

    eventsSeries.set("clustered", true);
    eventsSeries.set("clusteredSettings", {
      text: "{count}",
      fill: am5.color("#fcd34d"),
      stroke: am5.color("#b45309")
    });

    eventsSeries.bulletsContainer.events.on("click", ev => {
      const d = ev.target && ev.target.dataItem ? ev.target.dataItem.dataContext : null;
      if (!d) return;
      console.log("Event clicked:", d);
    });

    fetch("data/events.json?v=" + Date.now())
      .then(r => r.json())
      .then(data => eventsSeries.data.setAll(data))
      .catch(err => console.error("events load error", err));
  }

  function addAncientOverlay(chart, root) {
    const ancientSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
    ancientSeries.mapPolygons.template.setAll({
      tooltipText: "{name} — {period}",
      interactive: true,
      fillOpacity: 0.55,
      strokeOpacity: 1,
      strokeWidth: 1
    });
    // match hover/active to other maps
    ancientSeries.mapPolygons.template.states.create("hover",  { fillOpacity: 0.8 });
    ancientSeries.mapPolygons.template.states.create("active", { fill: am5.color("#b45309"), fillOpacity: 0.9 });

    ancientSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
      const dc = target.dataItem && target.dataItem.dataContext;
      const col = dc && dc.properties && dc.properties.fill;
      return col ? am5.color(col) : am5.color("#bcbcbc");
    });
    ancientSeries.mapPolygons.template.adapters.add("stroke", (stroke, target) => {
      const dc = target.dataItem && target.dataItem.dataContext;
      const col = dc && dc.properties && dc.properties.stroke;
      return col ? am5.color(col) : am5.color("#333333");
    });

    fetch("data/maps/ancient-israel.geojson?v=" + Date.now())
      .then(r => r.json())
      .then(geo => {
        ancientSeries.setAll({ geoJSON: geo });
        // Build legend from feature fills
        const rows = (geo.features || []).map(f => {
          const n = (f.properties && f.properties.name) || "Region";
          const c = (f.properties && f.properties.fill) || "#cccccc";
          return `<div class="row"><span class="swatch" style="background:${c}"></span>${n}</div>`;
        }).join("");
        legendEl.innerHTML = `<h4>Ancient Regions</h4>${rows}`;
        legendEl.classList.add('show');
      })
      .catch(err => console.error("ancient borders load error", err));
  }

  function makeMap(view) {
    disposeAll();

    root = am5.Root.new("chartdiv");
    root.setThemes([ am5themes_Animated.new(root) ]);

    chart = root.container.children.push(am5map.MapChart.new(root, {
      panX: "rotateX",
      panY: "translateY",
      projection: am5map.geoNaturalEarth1()
    }));

    chart.chartContainer.set("background", am5.Rectangle.new(root, { fill: am5.color("#e0f2ff") })); // ocean

    if (view === "africaME") {
      const africaSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_africaLow
      }));
      const meSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_middleEastLow
      }));
      styleSeries(africaSeries, root);
      styleSeries(meSeries, root);
      addEventsLayer(chart, root);
    } else if (view === "ancient") {
      // faint modern base for landmass context
      const baseME = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_region_world_middleEastLow
      }));
      styleFaint(baseME);
      // ancient overlay styled like other maps
      addAncientOverlay(chart, root);
      addEventsLayer(chart, root);
    } else {
      const cfg = {};
      if (view === "middleEast") {
        cfg.geoJSON = am5geodata_region_world_middleEastLow;
      } else {
        cfg.geoJSON = am5geodata_worldLow;
        cfg.exclude = ["AQ"];
      }
      const baseSeries = chart.series.push(am5map.MapPolygonSeries.new(root, cfg));
      styleSeries(baseSeries, root);
      addEventsLayer(chart, root);
    }

    zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
    zoomControl.homeButton.set("visible", true);
    zoomControl.homeButton.events.on("click", function() { chart.goHome(); });
    chart.chartContainer.get("background").events.on("click", function() { chart.goHome(); });

    chart.appear(600, 100);
  }

  const select = document.getElementById("mapSelect");
  makeMap(select.value);
  select.addEventListener("change", () => makeMap(select.value));
});
</script>
</body>
</html>
