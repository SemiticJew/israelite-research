<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Chapter — Israelite Research</title>
<link href="/israelite-research/styles.css" rel="stylesheet"/>
<style>
  :root{--ink:#0b2340;--accent:#F17300;--brand:#054A91;--muted:#6b7280;--sky:#DBE4EE;--white:#fff}

  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .page-header{padding:24px 0 8px}
  .page-title{margin:0;font-size:2rem;font-weight:800;color:var(--ink)}
  .crumbs{color:var(--muted);font-size:.9rem;margin-top:4px}

  .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin:16px 0 40px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}

  .panel{background:var(--white);border:1px solid var(--sky);border-radius:10px;padding:14px}

  .reader-toolbar{
    position: sticky; top: 0; z-index: 50;
    display:flex; align-items:center; justify-content:center; gap:.75rem;
    background:#fff; border:1px solid var(--sky); border-radius:10px;
    padding:.5rem; margin:10px 0 16px; box-shadow:0 1px 6px rgba(0,0,0,.05);
  }
  .reader-toolbar .btn{
    padding:.45rem .7rem; border:1px solid #e6ebf2; background:#fff; border-radius:10px; cursor:pointer; font:inherit;
  }
  .reader-toolbar .btn:hover{ background:#f8fafc }
  .reader-toolbar .ch-picker select{
    border:1px solid #e6ebf2; border-radius:10px; padding:.45rem .6rem; font:inherit;
  }

  .verse{display:flex; flex-direction:column; gap:.35rem; margin:.55rem 0; padding:.35rem .1rem; border-bottom:1px dashed var(--sky)}
  .vline{display:flex; gap:.6rem}
  .vnum{min-width:28px; text-align:right; color:var(--muted)}
  .vtext{line-height:1.55; color:#111}
  .v-toolbar{display:flex; gap:.4rem; padding-left:36px}
  .v-toolbar button{
    border:1px solid #e6ebf2; background:#fff; border-radius:8px; padding:.22rem .5rem; font-size:.82rem; cursor:pointer;
  }
  .v-toolbar button:hover{ background:#f8fafc }

  .hovercard{
    position:fixed; z-index:9999; display:none; max-width:min(380px, 92vw);
    background:#fff; border:1px solid #e6ebf2; border-radius:10px;
    box-shadow:0 8px 30px rgba(0,0,0,.12);
    padding:.6rem .7rem; font-size:.9rem;
  }
  .hovercard.open{ display:block }
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <header class="page-header">
    <h1 class="page-title" id="bookTitle">Loading…</h1>
    <div class="crumbs" id="crumbs"></div>
  </header>

  <div aria-label="Chapter navigation" class="reader-toolbar" id="readerToolbar" role="navigation">
    <button aria-label="Previous chapter" class="btn prev" id="btnPrev">← Prev</button>
    <div class="ch-picker">
      <label class="sr-only" for="chSelect">Select chapter</label>
      <select id="chSelect"></select>
    </div>
    <button aria-label="Next chapter" class="btn next" id="btnNext">Next →</button>
  </div>

  <section class="layout">
    <div class="panel">
      <h3 id="textPanelTitle">Text</h3>
      <div id="verses"><p class="muted">Loading…</p></div>
    </div>

    <aside class="panel" id="dictAside">
      <h3>Bible Dictionary</h3>
      <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
        <input id="dictSearch" placeholder="Search term (e.g., Eden, Covenant)…" style="flex:1; border:1px solid #DBE4EE; border-radius:10px; padding:.5rem .6rem" type="search"/>
      </div>
      <div id="dictPanel"><p class="muted">Loading Bible Dictionary…</p></div>
    </aside>
  </section>
</main>

<div id="site-footer"></div>
<div aria-hidden="true" class="hovercard" id="hovercard" role="dialog"></div>

<script src="/israelite-research/js/include.js"></script>
<script>
(function(){
  // --- URL params ---
  const params = new URLSearchParams(location.search);
  const bookSlug = (params.get('book') || '').trim();
  const ch = parseInt(params.get('ch') || '1', 10);

  // --- Title Case helper ---
  function titleCaseFromSlug(slug){
    if(!slug) return '';
    const parts = slug.split('-');
    const romans = { i:'I', ii:'II', iii:'III', iv:'IV', v:'V', vi:'VI', vii:'VII', viii:'VIII', ix:'IX', x:'X' };
    if(parts.length && romans[parts[0]]) parts[0] = romans[parts[0]];
    return parts.map((p,i)=> i===0 && romans[p] ? romans[p] : p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
  }

  function setBookTitle(){
    const title = titleCaseFromSlug(bookSlug) || 'Chapter';
    document.getElementById('bookTitle').textContent = title;
    document.title = title + ' — Chapter';
    document.getElementById('textPanelTitle').textContent = title + ' ' + (Number.isFinite(ch)? ch : '');
    document.getElementById('crumbs').textContent = title + (Number.isFinite(ch)? (' • Chapter ' + ch) : '');
  }

  // --- Chapter select wiring ---
  const chSelect = document.getElementById('chSelect');
  function populateChapterPicker(total=50){
    chSelect.innerHTML = '';
    for(let i=1;i<=total;i++){
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = 'Chapter ' + i;
      if(i===ch) opt.selected = true;
      chSelect.appendChild(opt);
    }
  }
  function goToChapter(n){
    const qs = new URLSearchParams(location.search);
    qs.set('ch', String(n));
    location.search = qs.toString();
  }
  document.getElementById('btnPrev').addEventListener('click', ()=> ch>1 && goToChapter(ch-1));
  document.getElementById('btnNext').addEventListener('click', ()=> goToChapter(ch+1));
  chSelect.addEventListener('change', (e)=> goToChapter(parseInt(e.target.value,10)||1));

  // --- Detect collection ---
  function detectCollection(){
    const p = location.pathname;
    if (p.includes('/tanakh/')) return 'tanakh';
    if (p.includes('/newtestament/')) return 'newtestament';
    if (p.includes('/apocrypha/')) return 'apocrypha';
    return 'scripture';
  }
  const collection = detectCollection();
  const versesEl = document.getElementById('verses');

  // --- Loader paths ---
  function jsonPerChapterPath(bookSlug, ch){
    return `/israelite-research/data/chapters/${collection}/${bookSlug}/${ch}.json`;
  }
  function jsonBundleCandidates(bookSlug){
    return [
      `/israelite-research/data/${collection}/${bookSlug}/1-50.json`,
      `/israelite-research/data/${collection}/${bookSlug}/all.json`,
      `/israelite-research/data/${collection}/${bookSlug}.json`,
    ];
  }
  function textPath(bookSlug, ch){
    return `/israelite-research/data/chapters/${collection}/${bookSlug}/${ch}.txt`;
  }

  // --- Normalize / Extract ---
  function normalizeVersesArray(input){
    const out = [];
    for (const row of input){
      if (!row) continue;
      if (typeof row === 'object' && 'n' in row && 't' in row) {
        out.push({ n: Number(row.n), t: String(row.t) });
      } else if (Array.isArray(row) && row.length >= 2) {
        out.push({ n: Number(row[0]), t: String(row[1]) });
      } else if (typeof row === 'string') {
        const m = row.match(/^\s*(\d{1,3})[.)]?\s+(.*)$/);
        if (m) out.push({ n: Number(m[1]), t: m[2] });
      }
    }
    return out;
  }
  function extractChapterFromBundle(data, ch){
    if (!data) return null;
    if (Array.isArray(data.verses)) return normalizeVersesArray(data.verses);
    if (data.chapters && typeof data.chapters === 'object' && !Array.isArray(data.chapters)){
      const bucket = data.chapters[String(ch)] || data.chapters[ch];
      return bucket ? normalizeVersesArray(bucket) : null;
    }
    if (Array.isArray(data.chapters)){
      let bucket = data.chapters[ch-1] || data.chapters[ch];
      return bucket ? normalizeVersesArray(bucket) : null;
    }
    if (Array.isArray(data)){
      const first = data[0];
      const looksLikeVerseObj = first && typeof first === 'object' && ('n' in first || Array.isArray(first) || (typeof first === 'string' && /^\s*\d/.test(first)));
      if (looksLikeVerseObj){ return normalizeVersesArray(data); }
      let bucket = data[ch-1] || data[ch];
      return bucket ? normalizeVersesArray(bucket) : null;
    }
    return null;
  }

  // --- Plain text split ---
  function splitPlainTextToVerses(txt){
    const pattern = /(^|\n)\s*(\d{1,3})[.)]?\s+/g;
    const verses = [];
    const indices = [];
    let match;
    while ((match = pattern.exec(txt)) !== null) {
      indices.push({ idx: match.index + match[0].length - (match[2].length + 1), num: parseInt(match[2], 10) });
    }
    if (!indices.length) return [{ n: 1, t: txt.trim() }];
    for (let i = 0; i < indices.length; i++){
      const start = indices[i].idx + (indices[i].num.toString().length + 1);
      const end = (i+1 < indices.length) ? indices[i+1].idx : txt.length;
      const body = txt.slice(start, end).trim();
      if (body) verses.push({ n: indices[i].num, t: body });
    }
    return verses;
  }

  // --- Render ---
  function renderVerses(verses){
    versesEl.innerHTML = '';
    verses.forEach(v=>{
      const wrap = document.createElement('div');
      wrap.className = 'verse';
      wrap.innerHTML = `
        <div class="vline">
          <div class="vnum">${v.n}</div>
          <div class="vtext">${v.t}</div>
        </div>
        <div class="v-toolbar">
          <button type="button" data-copy="${v.n}">Copy</button>
        </div>`;
      versesEl.appendChild(wrap);
    });
    versesEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-copy]');
      if(!btn) return;
      const n = btn.getAttribute('data-copy');
      const bookTitle = document.getElementById('bookTitle').textContent.replace(' — Chapter','');
      const text = `${bookTitle} ${ch}:${n} — ` + btn.closest('.verse').querySelector('.vtext').textContent;
      navigator.clipboard.writeText(text);
      btn.textContent = 'Copied!';
      setTimeout(()=> btn.textContent='Copy', 900);
    }, { once:true });
  }

  // --- Loaders ---
  async function fetchJson(url){
    const res = await fetch(url, { cache: 'force-cache' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }
  async function tryPerChapter(){
    try{
      const data = await fetchJson(jsonPerChapterPath(bookSlug, ch));
      if (data && Array.isArray(data.verses)) return data.verses;
    }catch(_){}
    return null;
  }
  async function tryBundle(){
    const candidates = jsonBundleCandidates(bookSlug);
    for (const url of candidates){
      try{
        const data = await fetchJson(url);
        const verses = extractChapterFromBundle(data, ch);
        if (verses && verses.length) return verses;
      }catch(_){}
    }
    return null;
  }
  async function tryText(){
    try{
      const res = await fetch(textPath(bookSlug, ch), { cache: 'force-cache' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      return splitPlainTextToVerses(txt);
    }catch(_){}
    return null;
  }
  async function loadChapter(){
    versesEl.innerHTML = '<p class="muted">Loading…</p>';
    const fromPerChapter = await tryPerChapter();
    if (fromPerChapter && fromPerChapter.length){ renderVerses(fromPerChapter); return; }
    const fromBundle = await tryBundle();
    if (fromBundle && fromBundle.length){ renderVerses(fromBundle); return; }
    const fromTxt = await tryText();
    if (fromTxt && fromTxt.length){ renderVerses(fromTxt); return; }
    versesEl.innerHTML = '<p class="muted">Chapter data unavailable.</p>';
  }

  // --- Boot ---
  setBookTitle();
  populateChapterPicker();
  loadChapter();
})();
</script>
</body>
</html>
