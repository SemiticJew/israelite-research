<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Chapter</title>
<link href="/israelite-research/styles.css" rel="stylesheet"/>
<style>
  :root{
    --ink:#0b2340; --accent:#F17300; --brand:#054A91;
    --muted:#6b7280; --sky:#DBE4EE; --white:#fff;
  }

  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .page-header{padding:24px 0 8px}
  .page-title{margin:0;font-size:2rem;font-weight:800;color:var(--ink)}
  .crumbs{color:var(--muted);font-size:.9rem;margin-top:4px}

  .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin:16px 0 40px}
  .panel{background:var(--white);border:1px solid var(--sky);border-radius:10px;padding:14px}
  .panel h3{margin:.2rem 0 .6rem;font-size:1.05rem;color:var(--brand)}

  /* Reader toolbar */
  .reader-toolbar{
    position: sticky; top: 0; z-index: 50;
    display:flex; align-items:center; justify-content:center; gap:.75rem;
    background:#fff; border:1px solid var(--sky); border-radius:10px;
    padding:.5rem; margin:10px 0 16px; box-shadow:0 1px 6px rgba(0,0,0,.05);
  }
  .reader-toolbar .btn{
    padding:.45rem .7rem; border:1px solid #e6ebf2; background:#fff; border-radius:10px; cursor:pointer; font:inherit;
  }
  .reader-toolbar .btn:hover{ background:#f8fafc }
  .reader-toolbar .ch-picker select{
    border:1px solid #e6ebf2; border-radius:10px; padding:.45rem .6rem; font:inherit;
  }

  /* Verse layout */
  .verse{display:flex; flex-direction:column; gap:.35rem; margin:.55rem 0; padding:.35rem .1rem; border-bottom:1px dashed var(--sky)}
  .vline{display:flex; gap:.6rem}
  .vnum{min-width:28px; text-align:right; color:var(--muted); font-variant-numeric: tabular-nums;}
  .vtext{color:#111; line-height:1.55}

  .v-toolbar{display:flex; gap:.4rem; padding-left:36px}
  .v-toolbar button{
    border:1px solid #e6ebf2; background:#fff; border-radius:8px; padding:.22rem .5rem; font-size:.82rem; cursor:pointer;
  }
  .v-toolbar button:hover{ background:#f8fafc }

  /* Modern sentence-style cross references */
  .xref-line{ font-size:.85rem; color:var(--muted); margin:.2rem 0 0; padding-left:36px }
  .xref-label{ font-weight:600; margin-right:.25rem; color:var(--ink) }
  .badge{
    display:inline-block;
    padding:.2rem .55rem;
    margin:0 .15rem;
    border-radius:999px;
    font-size:.8rem;
    font-weight:700;
    background:#f5f7fa;
    border:1px solid #e6ebf2;
    color:var(--brand);
    cursor:pointer;
    transition:all .15s ease;
  }
  .badge:hover{ background:var(--brand); color:#fff; border-color:var(--brand) }

  /* Dictionary */
  #dictAside h3 { text-align: center; }
  .muted{color:var(--muted)}
  .dict-input{
    flex:1; border:1px solid #DBE4EE; border-radius:10px; padding:.5rem .6rem; font:inherit;
  }
  .dict-entry h4{ margin:.3rem 0 .15rem; font-size:1rem; color:var(--ink) }
  .dict-entry p{ margin:.2rem 0 .6rem; color:#111; line-height:1.5 }

  @media (max-width:900px){ .layout{grid-template-columns:1fr} }
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <header class="page-header">
    <h1 class="page-title" id="pageTitle">Loading…</h1>
    <div class="crumbs" id="crumbs"></div>
  </header>

  <div aria-label="Chapter navigation" class="reader-toolbar" id="readerToolbar" role="navigation">
    <button aria-label="Previous chapter" class="btn prev" id="btnPrev">← Prev</button>
    <div class="ch-picker">
      <label class="sr-only" for="chSelect">Select chapter</label>
      <select id="chSelect"></select>
    </div>
    <button aria-label="Next chapter" class="btn next" id="btnNext">Next →</button>
  </div>

  <section class="layout">
    <div class="panel">
      <h3>Text</h3>
      <div id="verses"><p class="muted">Loading…</p></div>
    </div>

    <aside class="panel" id="dictAside">
      <h3>Bible Dictionary</h3>
      <div style="display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem">
        <input id="dictSearch" class="dict-input" placeholder="Search (e.g., Eden, Covenant, Jerusalem)…" type="search"/>
      </div>
      <div id="dictPanel"><p class="muted">Type a term to search Easton’s Bible Dictionary.</p></div>
    </aside>
  </section>
</main>

<div id="site-footer"></div>

<script src="/israelite-research/js/include.js"></script>
<script>
  // --- Helpers ---
  function getQueryParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name) || '';
  }
  function titleCaseFromSlug(slug){
    if(!slug) return '';
    // Handle 1/2/3-... OR i/ii/iii-... at start
    let m = slug.match(/^(\d+|i{1,3})-(.+)$/i);
    if(m){
      const lead = m[1];
      const rest = m[2].replace(/-/g,' ');
      // If numeric (1,2,3), keep numeric
      if(/^\d+$/.test(lead)){
        return lead + ' ' + rest.replace(/\b\w/g, c=>c.toUpperCase());
      }
      // If roman, keep ROMAN
      return lead.toUpperCase() + ' ' + rest.replace(/\b\w/g, c=>c.toUpperCase());
    }
    // Plain slug
    return slug.replace(/-/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
  }
  function detectCategory(){
    const p = location.pathname;
    if(p.includes('/tanakh/')) return 'tanakh';
    if(p.includes('/newtestament/')) return 'newtestament';
    if(p.includes('/apocrypha/')) return 'apocrypha';
    // Fallback
    return 'tanakh';
  }
  function chapterHref(cat, book, ch){
    return `/israelite-research/${cat}/chapter.html?book=${book}&ch=${ch}`;
  }

  // Cross-refs sentence style with modern badges
  function renderCrossRefs(refs){
    if(!refs || !refs.length) return '';
    const items = refs.map((r,i)=>{
      const sep = (i < refs.length - 1) ? '; ' : '.';
      return `<span class="badge" data-ref="${r}">${r}</span>${sep}`;
    }).join('');
    return `<div class="xref-line"><span class="xref-label">Cross-references:</span> ${items}</div>`;
  }

  // --- Boot ---
  const bookSlug = getQueryParam('book');
  let ch = parseInt(getQueryParam('ch') || '1', 10);
  const bookCat = detectCategory();

  const title = titleCaseFromSlug(bookSlug);
  document.getElementById('pageTitle').textContent = title || 'Chapter';
  document.getElementById('crumbs').textContent = `${title} ${isFinite(ch)?ch:''}`;

  // Populate chapters (prefer counts file; fall back to a sane default)
  async function loadChapterCount(){
    let max = 50; // fallback
    try{
      const resp = await fetch('/israelite-research/data/verse_counts/chapter_counts.json');
      if(resp.ok){
        const counts = await resp.json(); // { "genesis":50, "1-kings":22, ... }
        if(counts[bookSlug] && Number.isInteger(counts[bookSlug])){
          max = counts[bookSlug];
        }
      }
    }catch(e){}
    const sel = document.getElementById('chSelect');
    sel.innerHTML = '';
    for(let i=1;i<=max;i++){
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = i;
      if(i===ch) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  // Load verses for the chapter
  async function loadChapter(){
    const versesEl = document.getElementById('verses');
    versesEl.innerHTML = '<p class="muted">Loading…</p>';
    try{
      const url = `/israelite-research/data/${bookCat}/${bookSlug}/${ch}.json`;
      const resp = await fetch(url);
      if(!resp.ok){
        versesEl.innerHTML = '<p class="muted">Chapter not found.</p>';
        return;
      }
      const data = await resp.json(); // [{ v, t, c:[...], s:[...] }]
      versesEl.innerHTML = '';
      data.forEach(v=>{
        const wrap = document.createElement('div');
        wrap.className = 'verse';
        wrap.innerHTML = `
          <div class="vline">
            <div class="vnum">${v.v}</div>
            <div class="vtext">${v.t}</div>
          </div>
          <div class="v-toolbar">
            <button type="button" data-copy="${v.v}">Copy</button>
          </div>
          ${renderCrossRefs(v.c)}
        `;
        versesEl.appendChild(wrap);
      });

      // Copy handler (once per load)
      versesEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-copy]');
        if(!btn) return;
        const n = btn.getAttribute('data-copy');
        const verseText = btn.closest('.verse').querySelector('.vtext')?.textContent || '';
        const clip = `${title} ${ch}:${n} — ${verseText}`;
        navigator.clipboard.writeText(clip);
        btn.textContent = 'Copied!';
        setTimeout(()=> btn.textContent='Copy', 900);
      }, { once:true });

    }catch(err){
      versesEl.innerHTML = '<p class="muted">Error loading chapter.</p>';
    }
  }

  // Toolbar wiring
  document.getElementById('btnPrev').addEventListener('click', ()=>{
    const sel = document.getElementById('chSelect');
    const v = Math.max(1, parseInt(sel.value,10)-1);
    location.assign(chapterHref(bookCat, bookSlug, v));
  });
  document.getElementById('btnNext').addEventListener('click', ()=>{
    const sel = document.getElementById('chSelect');
    const max = sel.options.length ? parseInt(sel.options[sel.options.length-1].value,10) : 150;
    const v = Math.min(max, parseInt(sel.value,10)+1);
    location.assign(chapterHref(bookCat, bookSlug, v));
  });
  document.getElementById('chSelect').addEventListener('change', (e)=>{
    const v = parseInt(e.target.value,10);
    if(Number.isInteger(v)) location.assign(chapterHref(bookCat, bookSlug, v));
  });

  // Bible Dictionary (Easton)
  let eastonIndex = null;
  async function ensureDictionary(){
    if(eastonIndex) return;
    try{
      const resp = await fetch('/israelite-research/data/dictionaries/easton_dictionary.json');
      if(resp.ok){
        eastonIndex = await resp.json(); // { "EDEN": "text...", ... }
      }
    }catch(e){}
  }
  const dictInput = document.getElementById('dictSearch');
  const dictPanel = document.getElementById('dictPanel');
  dictInput.addEventListener('input', async (e)=>{
    const q = (e.target.value || '').trim();
    if(!q){ dictPanel.innerHTML = '<p class="muted">Type a term to search Easton’s Bible Dictionary.</p>'; return; }
    await ensureDictionary();
    if(!eastonIndex){ dictPanel.innerHTML = '<p class="muted">Dictionary not available.</p>'; return; }
    const key = q.toUpperCase();
    const exact = eastonIndex[key];
    if(exact){
      dictPanel.innerHTML = `<div class="dict-entry"><h4>${q}</h4><p>${exact}</p></div>`;
      return;
    }
    // Simple contains scan (first few)
    const results = Object.keys(eastonIndex).filter(k => k.includes(key)).slice(0,8);
    if(!results.length){
      dictPanel.innerHTML = '<p class="muted">No results.</p>';
      return;
    }
    dictPanel.innerHTML = results.map(k=>(
      `<div class="dict-entry"><h4>${k}</h4><p>${eastonIndex[k]}</p></div>`
    )).join('');
  });

  // Init
  (async function init(){
    await loadChapterCount();
    await loadChapter();
  })();
</script>
</body>
</html>
