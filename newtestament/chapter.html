<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bible — Chapter</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340;--accent:#F17300;--brand:#054A91;--muted:#6b7280;--sky:#DBE4EE;--white:#fff}
  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .page-header{padding:24px 0 8px}
  .page-title{margin:0;font-size:2rem;font-weight:800}
  .crumbs{color:var(--muted);font-size:.9rem;margin-top:4px}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin:16px 0 40px}
  .panel{background:var(--white);border:1px solid var(--sky);border-radius:10px;padding:14px}
  .muted{color:var(--muted)}
  .verse{display:flex;gap:8px;margin:.45rem 0;position:relative;padding-right:84px;cursor:pointer;border-bottom:1px solid var(--sky);padding-bottom:.45rem}
  .verse:last-child{border-bottom:0}
  .vnum{min-width:26px;text-align:right;color:var(--muted)}
  .vtext{color:#111;line-height:1.5}
  .panel h3{margin:.2rem 0 0.6rem;font-size:1.05rem;color:var(--brand)}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
/* Verses list layout */
#verses{ display:block; margin-top:.25rem }

/* Verse “card” */
.verse{
  position:relative;
  display:flex; align-items:flex-start; gap:.75rem;
  padding:.75rem .9rem .75rem 3.25rem;
  margin:.55rem 0;
  border:1px solid var(--sky);
  border-radius:12px;
  background:#fff;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
  transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.verse:hover{
  border-color:#cfd9e6;
  box-shadow:0 4px 18px rgba(0,0,0,.06);
  background:#fbfdff;
}
.verse.active{
  outline:2px solid rgba(5,74,145,.18);
  background:rgba(5,74,145,.04);
}

/* Verse number badge */
.vnum{
  position:absolute; left:.9rem; top:.8rem;
  min-width:34px; height:34px; line-height:34px;
  display:inline-block; text-align:center;
  font-weight:700; font-size:.9rem; color:var(--brand);
  background:#f1f6fb; border:1px solid var(--sky);
  border-radius:999px;
}

/* Verse text */
.vtext{
  display:block;
  color:#0e1622; line-height:1.6; font-size:1.02rem;
  word-break:break-word;
}

/* Verse actions appear on hover */
.v-actions{
  position:absolute; right:.55rem; top:.55rem;
  display:flex; gap:.4rem; opacity:0; pointer-events:none;
  transition:opacity .12s ease;
}
.verse:hover .v-actions{ opacity:1; pointer-events:auto }
.v-actions button{
  border:1px solid #e6ebf2; background:#fff; border-radius:8px;
  padding:.2rem .45rem; font-size:.78rem; cursor:pointer;
}
.v-actions button:hover{ background:#f8fafc }

  /* Toolbar */
  .reader-toolbar{
    position: sticky; top: 0; z-index: 50;
    display:flex; align-items:center; justify-content:center; flex-wrap:wrap; gap:.6rem .75rem;
    background:#fff; border:1px solid var(--sky); border-radius:10px;
    padding:.5rem; margin:10px 0 16px; box-shadow:0 1px 6px rgba(0,0,0,.05);
  }
  .reader-toolbar .btn,
  .reader-toolbar select,
  .reader-toolbar input[type="search"]{
    padding:.45rem .6rem; border:1px solid #e6ebf2; background:#fff; border-radius:10px; font:inherit;
  }
  .reader-toolbar .btn{ cursor:pointer }
  .reader-toolbar .btn:hover{ background:#f8fafc }
  .reader-toolbar .group{display:flex; align-items:center; gap:.45rem}
  .reader-toolbar label.sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}

  /* Verse actions */
  .v-actions{position:absolute; right:6px; top:2px; display:flex; gap:6px}
  .v-actions button{
    border:1px solid #e6ebf2; background:#fff; border-radius:8px; padding:.15rem .35rem;
    font-size:.78rem; cursor:pointer;
  }
  .v-actions button:hover{ background:#f8fafc }

  /* Hover card */
  .hovercard{
    position:fixed; z-index:9999; display:none; max-width:min(380px, 92vw);
    background:#fff; border:1px solid #e6ebf2; border-radius:10px;
    box-shadow:0 8px 30px rgba(0,0,0,.12);
    padding:.6rem .7rem; font-size:.9rem;
  }
  .hovercard.open{ display:block }

  /* Bible Dictionary search toggle */
  .search-wrap{ display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem }
  .icon-btn{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; border:1px solid #e6ebf2; border-radius:10px;
    background:#fff; cursor:pointer;
  }
  .icon-btn:hover{ background:#f8fafc }
  .icon-btn svg{ width:18px; height:18px; }

  /* Collapsible input */
  #dictQuery{
    width:0; opacity:0; padding:.45rem .6rem;
    border:1px solid #e6ebf2; border-radius:10px; font:inherit;
    transition: width .18s ease, opacity .18s ease, padding .18s ease, border-color .18s ease;
  }
  .search-wrap.open #dictQuery{
    width:220px; opacity:1; padding:.45rem .6rem;
  }
  @media (max-width: 520px){
    .search-wrap.open #dictQuery{ width: 100%; }
  }
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <header class="page-header">
    <h1 class="page-title" id="pageTitle">Bible (KJV)</h1>
    <div class="crumbs" id="crumbs">Loading…</div>
  </header>

  <!-- Sticky reader toolbar -->
  <nav class="reader-toolbar" id="readerToolbar" aria-label="Chapter navigation">
    <div class="group">
      <button class="btn prev" id="btnPrev" aria-label="Previous chapter">← Prev</button>
      <label for="chSelect" class="sr-only">Select chapter</label>
      <select id="chSelect" aria-label="Chapter"></select>
      <button class="btn next" id="btnNext" aria-label="Next chapter">Next →</button>
    </div>

    <!-- Canon + Book picker (dynamic from books.json) -->
    <div class="group" aria-label="Canon and Book">
      <label for="canonPick" class="sr-only">Canon</label>
      <select id="canonPick" aria-label="Canon">
        <option value="tanakh">Tanakh</option>
        <option value="newtestament">New Testament</option>
        <option value="apocrypha">Apocrypha</option>
      </select>

      <label for="bookPick" class="sr-only">Book</label>
      <select id="bookPick" aria-label="Book"></select>

      <button class="btn" id="goPick" aria-label="Go to selection">Go</button>
    </div>
  </nav>

  <section class="layout">
    <div class="panel">
      <h3>Text</h3>
      <div id="verses"><p class="muted">Loading…</p></div>
    </div>

    <!-- Right panel: Bible Dictionary -->
    <aside class="panel" id="dictPanel">
      <h3 style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
        <span>Bible Dictionary</span>
        <button class="icon-btn" id="dictToggle" aria-expanded="false" aria-controls="dictQuery" title="Search dictionary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </h3>

      <div class="search-wrap" id="dictSearchWrap">
        <input id="dictQuery" type="search" placeholder="Search terms (Ham, Ethiopia, Passover)" autocomplete="off" />
        <button class="icon-btn" id="dictClear" title="Clear search" aria-label="Clear search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div id="dictResults"><p class="muted">Tap the magnifying glass to search.</p></div>
    </aside>
  </section>
</main>

<div id="site-footer"></div>

<div id="hovercard" class="hovercard" role="dialog" aria-hidden="true"></div>

<script src="/israelite-research/js/include.js" defer></script>
<script src="/israelite-research/js/nt-chapter.js" defer></script>

<!-- Canon-aware header/crumbs (matches loader’s book label logic) -->
<script>
(function(){
  const parts = location.pathname.split('/').filter(Boolean);
  const C = ['tanakh','newtestament','apocrypha'];
  const canon = C.find(c => parts.includes(c)) || 'newtestament';
  const idx = parts.indexOf(canon);
  const book = (idx !== -1 && parts[idx+1]) ? parts[idx+1] : '';
  const ch = new URLSearchParams(location.search).get('c') || (location.pathname.match(/chapter-(\d+)/i)?.[1] || '1');

  const canonLabel = canon === 'tanakh' ? 'Tanakh' : canon === 'apocrypha' ? 'Apocrypha' : 'New Testament';
  const label = (book||'')
    .replace(/-/g,' ')
    .replace(/\biii\b/g,'III').replace(/\bii\b/g,'II').replace(/\bi\b/g,'I')
    .replace(/\b\w/g,c=>c.toUpperCase());

  document.getElementById('pageTitle').textContent = `${canonLabel} (KJV)`;
  document.getElementById('crumbs').textContent = `${canonLabel} ${label ? `→ ${label}` : ''} → Chapter ${ch}`;
})();
</script>

<!-- Canon + Book picker wiring (dynamic from books.json) -->
<script>
(async function(){
  const canonPick = document.getElementById('canonPick');
  const bookPick  = document.getElementById('bookPick');
  const goBtn     = document.getElementById('goPick');

  const parts = location.pathname.split('/').filter(Boolean);
  const CANONS = ['tanakh','newtestament','apocrypha'];
  const canon = CANONS.find(c => parts.includes(c)) || 'newtestament';
  const idx = parts.indexOf(canon);
  const curBook = (idx !== -1 && parts[idx+1]) ? parts[idx+1] : 'matthew';
  const curCh = parseInt(new URLSearchParams(location.search).get('c') || (location.pathname.match(/chapter-(\d+)/i)?.[1] || '1'), 10);

  canonPick.value = canon;

  const LABEL = s => s.replace(/-/g,' ')
                      .replace(/\biii\b/g,'III').replace(/\bii\b/g,'II').replace(/\bi\b/g,'I')
                      .replace(/\b\w/g,c=>c.toUpperCase());

  async function loadBooks(c) {
    const url = `/israelite-research/data/${c}/books.json`;
    try {
      const r = await fetch(url, {cache:'force-cache'});
      if (!r.ok) return [];
      const obj = await r.json(); // {slug: total, ...}
      return Object.keys(obj);
    } catch { return []; }
  }

  async function fill(c, current) {
    const list = await loadBooks(c);
    bookPick.innerHTML = '';
    (list.length ? list : [current]).forEach(slug=>{
      const opt = document.createElement('option');
      opt.value = slug; opt.textContent = LABEL(slug);
      if (slug === current) opt.selected = true;
      bookPick.appendChild(opt);
    });
  }

  await fill(canon, curBook);
  canonPick.addEventListener('change', () => fill(canonPick.value, (bookPick.value || 'genesis')));

  goBtn.addEventListener('click', ()=>{
    const c = canonPick.value;
    const b = bookPick.value;
    const n = Math.max(1, parseInt(curCh||'1',10));
    location.href = `/israelite-research/${c}/${b}/chapter.html?c=${n}`;
  });
})();
</script>

<script>
(function(){
  const canonPick=document.getElementById("canonPick");
  const bookPick=document.getElementById("bookPick");
  const goBtn=document.getElementById("goPick");
  if(!goBtn||!canonPick||!bookPick) return;
  goBtn.addEventListener("click", ()=>{
    const c=canonPick.value||"newtestament";
    const b=bookPick.value||"matthew";
    const q=new URLSearchParams(location.search);
    const cur = parseInt(q.get("c")||q.get("ch")||"1",10);
    const n = Math.max(1, cur);
    location.href = `/israelite-research/${c}/${b}/chapter.html?c=${n}`;
  });
})();
</script>

<!-- Bible Dictionary search (magnifying glass toggle) -->
<script>
(function(){
  const wrap     = document.getElementById('dictSearchWrap');
  const toggle   = document.getElementById('dictToggle');
  const input    = document.getElementById('dictQuery');
  const clearBtn = document.getElementById('dictClear');
  const out      = document.getElementById('dictResults');
  const BASE = '/israelite-research';

  const CANDIDATES = [
    `${BASE}/data/dictionary/easton_dictionary.json`,
    `${BASE}/data/dictionary/dictionary.json`,
    `${BASE}/data/dictionary/index.json`
  ];
  let INDEX = [];

  function openSearch(){ wrap.classList.add('open'); toggle.setAttribute('aria-expanded','true'); setTimeout(()=>input.focus(),160); }
  function closeSearch(){
    if (!wrap.classList.contains('open')) return;
    wrap.classList.remove('open');
    toggle.setAttribute('aria-expanded','false');
    if (!input.value.trim()){
      out.innerHTML = '<p class="muted">Tap the magnifying glass to search.</p>';
    }
  }
  toggle.addEventListener('click', ()=>{ wrap.classList.contains('open') ? closeSearch() : openSearch(); });
  input.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ input.blur(); closeSearch(); } });
  document.addEventListener('click', (e)=>{
    if (!wrap.contains(e.target) && !toggle.contains(e.target) && !input.value.trim()){ closeSearch(); }
  });

  async function loadIndex(){
    for (const url of CANDIDATES){
      try{ const r=await fetch(url,{cache:'force-cache'}); if(r.ok){ const data=await r.json(); INDEX=normalize(data); if(INDEX.length) return; } }catch(_){}
  }
  function slugify(s){ return String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function normalize(data){
    if (Array.isArray(data)) return data.map(x=>({id:x.id||slugify(x.term||x.title||''),term:x.term||x.title||'',summary:x.summary||x.desc||x.definition||'',refs:x.refs||x.biblical_refs||[]}))
      .filter(x=>x.term);
    if (data && typeof data==='object') return Object.entries(data).map(([k,v])=>({id:v?.id||slugify(k),term:k,summary:v?.summary||v?.desc||v?.definition||'',refs:v?.refs||v?.biblical_refs||[]}));
    return [];
  }
  function render(results){
    if(!results.length){ out.innerHTML='<p class="muted">No results.</p>'; return; }
    const frag=document.createDocumentFragment();
    results.slice(0,50).forEach(rec=>{
      const card=document.createElement('div');
      card.style.borderTop='1px solid var(--sky)'; card.style.padding='.5rem 0';
      const term=document.createElement('div'); term.style.fontWeight='700'; term.style.color='var(--ink)'; term.textContent=rec.term;
      const sum=document.createElement('div'); sum.style.marginTop='2px'; sum.textContent=rec.summary||'(no summary yet)';
      card.appendChild(term); card.appendChild(sum);
      if(Array.isArray(rec.refs)&&rec.refs.length){
        const ul=document.createElement('ul'); ul.style.margin='.35rem 0 0'; ul.style.paddingLeft='1.1rem';
        rec.refs.slice(0,8).forEach(ref=>{const li=document.createElement('li'); li.textContent=ref; ul.appendChild(li);});
        card.appendChild(ul);
      }
      frag.appendChild(card);
    });
    out.innerHTML=''; out.appendChild(frag);
  }
  function search(qs){
    const term=String(qs||'').trim().toLowerCase();
    if(!term){ out.innerHTML='<p class="muted">Tap the magnifying glass to search.</p>'; return; }
    const res=INDEX.filter(r=> (r.term||'').toLowerCase().includes(term) || (r.summary||'').toLowerCase().includes(term) )
                   .sort((a,b)=>a.term.localeCompare(b.term));
    render(res);
  }

  let timer=null;
  input.addEventListener('input',()=>{ clearTimeout(timer); timer=setTimeout(()=>search(input.value),180); });
  clearBtn.addEventListener('click',()=>{ input.value=''; input.focus(); search(''); });

  loadIndex();
})();
</script>
</body>
</html>
