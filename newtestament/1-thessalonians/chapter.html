<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>New Testament — Chapter</title>
<link rel="stylesheet" href="/israelite-research/styles.css"/>
<style>
  :root{--ink:#0b2340;--accent:#F17300;--brand:#054A91;--muted:#6b7280;--sky:#DBE4EE;--white:#fff}
  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .page-header{padding:24px 0 8px}
  .page-title{margin:0;font-size:2rem;font-weight:800}
  .crumbs{color:var(--muted);font-size:.9rem;margin-top:4px}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin:16px 0 40px}
  .panel{background:var(--white);border:1px solid var(--sky);border-radius:10px;padding:14px}
  .muted{color:var(--muted)}
  .verse{display:flex;gap:8px;margin:.45rem 0;position:relative;padding-right:84px;cursor:pointer}
  .vnum{min-width:26px;text-align:right;color:var(--muted)}
  .vtext{color:#111;line-height:1.5}
  .panel h3{margin:.2rem 0 0.6rem;font-size:1.05rem;color:var(--brand)}
  .lex{margin:0;padding-left:1.1rem}
  .lex li{margin:.35rem 0}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}

  /* Toolbar */
  .reader-toolbar{
    position: sticky; top: 0; z-index: 50;
    display:flex; align-items:center; justify-content:center; gap:.75rem;
    background:#fff; border:1px solid var(--sky); border-radius:10px;
    padding:.5rem; margin:10px 0 16px; box-shadow:0 1px 6px rgba(0,0,0,.05);
  }
  .reader-toolbar .btn{
    padding:.45rem .7rem; border:1px solid #e6ebf2; background:#fff; border-radius:10px; cursor:pointer; font:inherit;
  }
  .reader-toolbar .btn:hover{ background:#f8fafc }
  .reader-toolbar .ch-picker select{
    border:1px solid #e6ebf2; border-radius:10px; padding:.45rem .6rem; font:inherit;
  }

  /* Verse actions */
  .v-actions{position:absolute; right:6px; top:2px; display:flex; gap:6px}
  .v-actions button{
    border:1px solid #e6ebf2; background:#fff; border-radius:8px; padding:.15rem .35rem;
    font-size:.78rem; cursor:pointer;
  }
  .v-actions button:hover{ background:#f8fafc }

  /* Strong’s badges */
  .badge{
    display:inline-block; margin-left:.35rem; padding:.05rem .35rem; border:1px solid var(--sky);
    border-radius:8px; font-size:.78rem; color:#333; background:#054A910D; cursor:pointer;
  }

  /* Hover card */
  .hovercard{
    position:fixed; z-index:9999; display:none; max-width:min(380px, 92vw);
    background:#fff; border:1px solid #e6ebf2; border-radius:10px;
    box-shadow:0 8px 30px rgba(0,0,0,.12);
    padding:.6rem .7rem; font-size:.9rem;
  }
  .hovercard.open{ display:block }

  .sr-only{ position:absolute!important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px) }

  /* Verse Commentary UI */
  .vc-head{display:flex; align-items:center; justify-content:space-between; gap:.5rem; margin-bottom:.4rem}
  .vc-ref{font-weight:700; color:var(--ink)}
  .vc-buttons{display:flex; gap:.4rem}
  .vc-btn{border:1px solid #e6ebf2; background:#fff; border-radius:8px; padding:.3rem .55rem; font:inherit; cursor:pointer}
  .vc-btn:hover{background:#f8fafc}
  .vc-text{width:100%; min-height:160px; border:1px solid var(--sky); border-radius:10px; padding:.6rem; font:inherit; line-height:1.5}
  .vc-foot{display:flex; align-items:center; justify-content:space-between; margin-top:.4rem}
  .vc-saved{font-size:.85rem; color:var(--muted)}
  .vc-list{margin:.4rem 0 0; padding-left:1.1rem}
  .vc-list li{margin:.25rem 0}
  .vc-empty{color:var(--muted)}
  .verse.active{background:rgba(5,74,145,.06); border-radius:8px}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="container">
  <header class="page-header">
    <h1 class="page-title" id="pageTitle">New Testament (KJV)</h1>
    <div class="crumbs" id="crumbs">New Testament → Book → Chapter</div>
  </header>

  <!-- Sticky reader toolbar -->
  <div class="reader-toolbar" id="readerToolbar" role="navigation" aria-label="Chapter navigation">
    <button class="btn prev" id="btnPrev" aria-label="Previous chapter">← Prev</button>
    <div class="ch-picker">
      <label for="chSelect" class="sr-only">Select chapter</label>
      <select id="chSelect"></select>
    </div>
    <button class="btn next" id="btnNext" aria-label="Next chapter">Next →</button>
  </div>

  <section class="layout">
    <div class="panel">
      <h3>Text</h3>
      <!-- Tip: nt-chapter.js should render each verse as .verse with a .vnum -->
      <div id="verses"><p class="muted">Loading…</p></div>
    </div>

    <aside class="panel">
      <h3>Strong’s (Lexicon)</h3>
      <div id="lexicon"><p class="muted">Loading…</p></div>

      <hr style="border:none;border-top:1px solid var(--sky);margin:12px 0">

      <h3>Verse Commentary</h3>
      <div id="vcPanel" aria-live="polite">
        <div class="vc-head">
          <div class="vc-ref" id="vcRef">Click a verse to add a note</div>
          <div class="vc-buttons">
            <button class="vc-btn" id="vcClear" title="Clear note for this verse" disabled>Clear</button>
          </div>
        </div>
        <textarea class="vc-text" id="vcText" placeholder="Start typing your personal commentary for the selected verse…" disabled></textarea>
        <div class="vc-foot">
          <button class="vc-btn" id="vcSave" disabled>Save</button>
          <div class="vc-saved" id="vcSaved"></div>
        </div>

        <details style="margin-top:.6rem">
          <summary>All notes in this chapter</summary>
          <ul class="vc-list" id="vcList"><li class="vc-empty">No verse notes yet.</li></ul>
        </details>
      </div>
    </aside>
  </section>
</main>

<div id="site-footer"></div>

<!-- Hovercard for Strong’s -->
<div id="hovercard" class="hovercard" role="dialog" aria-hidden="true"></div>

<script src="/israelite-research/js/include.js"></script>
<script src="/israelite-research/js/nt-chapter.js"></script>

<!-- Minimal inline logic for verse-by-verse notes (non-invasive to nt-chapter.js) -->
<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const versesEl = $('#verses');
  const vcRef = $('#vcRef');
  const vcText = $('#vcText');
  const vcSave = $('#vcSave');
  const vcClear = $('#vcClear');
  const vcSaved = $('#vcSaved');
  const vcList = $('#vcList');

  // chapterKey: unique per chapter page (e.g., /newtestament/matthew/1)
  const chapterKey = (location.pathname.replace(/\.html?$/,'') || 'nt-chapter');
  const storeKey = 'vc:' + chapterKey;

  let notes = {};
  try { notes = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch(_) { notes = {}; }
  let currentVerse = null;
  let saveTimer = null;

  function verseNumberFrom(el){
    const verse = el.closest('.verse');
    if(!verse) return null;
    // Prefer explicit data attribute if nt-chapter.js sets it
    const d = verse.getAttribute('data-verse');
    if(d) return String(d).trim();
    // Fallback: read from .vnum text
    const num = verse.querySelector('.vnum')?.textContent?.trim();
    return num || null;
  }

  function selectVerseByElement(el){
    const vnum = verseNumberFrom(el);
    if(!vnum) return;

    if(currentVerse){
      // remove previous highlight
      const prev = versesEl.querySelector(`.verse[data-verse="${currentVerse}"], .verse:has(.vnum)`);
      versesEl.querySelectorAll('.verse').forEach(v=>v.classList.remove('active'));
    }
    // highlight current
    const verseEl = el.closest('.verse');
    if(verseEl) verseEl.classList.add('active');

    currentVerse = vnum;
    const existing = notes[vnum] || '';
    vcRef.textContent = `Commentary on verse ${vnum}`;
    vcText.disabled = false;
    vcSave.disabled = false;
    vcClear.disabled = false;
    vcText.value = existing;
    vcText.focus();
    vcText.setSelectionRange(vcText.value.length, vcText.value.length);
    vcSaved.textContent = existing ? 'Loaded saved note.' : '';
  }

  function persist(){
    localStorage.setItem(storeKey, JSON.stringify(notes));
    renderList();
  }

  function renderList(){
    const entries = Object.entries(notes).filter(([_,v])=>v && v.trim().length);
    entries.sort((a,b)=>Number(a[0]) - Number(b[0]));
    vcList.innerHTML = '';
    if(!entries.length){
      vcList.innerHTML = '<li class="vc-empty">No verse notes yet.</li>';
      return;
    }
    for(const [v,txt] of entries){
      const li = document.createElement('li');
      const safe = txt.length > 140 ? txt.slice(0,140) + '…' : txt;
      li.innerHTML = `<a href="#" data-jump="${v}">v${v}</a> — ${escapeHtml(safe)}`;
      vcList.appendChild(li);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Click a verse anywhere in #verses to select it
  versesEl.addEventListener('click', (e) => {
    const verseEl = e.target.closest('.verse');
    if(!verseEl) return;
    selectVerseByElement(verseEl);
  });

  // Jump from the list
  vcList.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-jump]');
    if(!a) return;
    e.preventDefault();
    const vnum = a.getAttribute('data-jump');
    const target = Array.from(versesEl.querySelectorAll('.verse'))
      .find(v => v.getAttribute('data-verse') === vnum || v.querySelector('.vnum')?.textContent?.trim() === vnum);
    if(target){ target.scrollIntoView({behavior:'smooth', block:'center'}); selectVerseByElement(target); }
  });

  // Save (manual)
  vcSave.addEventListener('click', ()=>{
    if(!currentVerse) return;
    notes[currentVerse] = vcText.value.trim();
    persist();
    vcSaved.textContent = 'Saved.';
    setTimeout(()=>vcSaved.textContent = '', 1200);
  });

  // Auto-save while typing (debounced)
  vcText.addEventListener('input', ()=>{
    if(!currentVerse) return;
    vcSaved.textContent = 'Saving…';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      notes[currentVerse] = vcText.value.trim();
      persist();
      vcSaved.textContent = 'Saved.';
      setTimeout(()=>vcSaved.textContent = '', 900);
    }, 400);
  });

  // Clear current verse note
  vcClear.addEventListener('click', ()=>{
    if(!currentVerse) return;
    delete notes[currentVerse];
    persist();
    vcText.value = '';
    vcSaved.textContent = 'Cleared.';
    setTimeout(()=>vcSaved.textContent = '', 900);
    renderList();
  });

  // Initial list render
  renderList();
})();
</script>
<script>
(function(){
  const path = location.pathname.replace(/\/+$/,'');
  const parts = path.split('/');
  const i = parts.findIndex(p => p.toLowerCase() === 'newtestament');
  const bookSlug = (i >= 0 && parts[i+1]) ? decodeURIComponent(parts[i+1]) : '';
  const toTitle = s => s.replace(/[-_]/g,' ').replace(/\b\w/g, c => c.toUpperCase());
  const book = bookSlug ? toTitle(bookSlug) : 'New Testament';

  const h1 = document.getElementById('pageTitle');
  const crumbs = document.getElementById('crumbs');
  if (h1) h1.textContent = `${book} (KJV)`;
  if (crumbs) crumbs.textContent = `New Testament → ${book} → Chapter`;
  document.title = `${book} — Chapter`;
})();
</script>
</body>
</html>
