<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bible References — Semitic Jew</title>
  <link rel="stylesheet" href="/israelite-research/styles.css"/>
  <style>
    :root{
      --ink:#0b2340; --muted:#6b7280; --brand:#054A91; --accent:#F17300;
      --sky:#DBE4EE; --card:#fff; --border:#e6ebf2; --bg:#f7fafc;
    }
    body{background:#fff}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    header.page-header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--sky);padding:10px 0 12px}
    .head-row{display:grid;grid-template-columns:1fr 560px;gap:12px;align-items:center}
    .page-title{margin:0;font-size:1.35rem;font-weight:800;color:var(--ink)}
    /* Omnibar */
    .omnibar{display:flex;gap:.5rem;align-items:center}
    .omnibar input[type="search"]{flex:1;border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem;font:inherit}
    .omnibar .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .8rem;cursor:pointer;font:inherit}
    .omnibar .btn:hover{background:#f8fafc}
    /* Quick filters */
    .quick-filters{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:6px}
    .qchip{border:1px solid var(--sky);background:#fff;border-radius:999px;padding:.18rem .6rem;font-size:.82rem;cursor:pointer}
    .qchip[data-active="1"]{background:#054A910D}
    /* A–Z bar */
    .azbar{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:6px}
    .azbar button{border:1px solid var(--sky);background:#fff;border-radius:6px;padding:.2rem .45rem;font-size:.8rem;cursor:pointer}
    .azbar button:hover{background:#f8fafc}
    /* Layout */
    .layout{display:grid;grid-template-columns:380px 1fr;gap:16px;margin:14px 0 40px}
    @media (max-width:980px){ .layout{grid-template-columns:1fr} .head-row{grid-template-columns:1fr} }
    /* Results list */
    .results{background:var(--card);border:1px solid var(--sky);border-radius:12px;padding:10px;max-height:calc(100vh - 180px);overflow:auto}
    .r-card{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px;margin:8px 0}
    .r-top{display:flex;justify-content:space-between;gap:8px;align-items:baseline}
    .r-term{font-weight:800;color:var(--brand)}
    .r-src{font-size:.78rem;border:1px solid var(--sky);border-radius:999px;padding:.05rem .4rem;background:#f8fafc}
    .r-abs{margin-top:4px;color:#374151;font-size:.95rem}
    .r-actions{display:flex;gap:.35rem;margin-top:6px}
    .r-actions button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:.25rem .5rem;font-size:.82rem;cursor:pointer}
    .r-actions button:hover{background:#f8fafc}
    /* Reader */
    .reader{background:var(--card);border:1px solid var(--sky);border-radius:12px;padding:12px;min-height:320px}
    .rd-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .rd-title{margin:0;font-size:1.25rem;font-weight:800;color:var(--ink)}
    .rd-badges{display:flex;gap:.35rem;flex-wrap:wrap}
    .badge{border:1px solid var(--sky);background:#fff;border-radius:999px;padding:.12rem .5rem;font-size:.78rem}
    .rd-body{margin-top:8px}
    .rd-body p{margin:.5rem 0}
    .muted{color:var(--muted)}
    /* Hover verse card reused from dietary page */
    .hovercard{
      position:absolute; z-index:9999; display:none; max-width:min(380px, 92vw);
      background:#fff; border:1px solid var(--border); border-radius:10px;
      box-shadow:0 8px 30px rgba(0,0,0,.12); padding:.6rem .7rem; font-size:.9rem;
    }
    .hovercard.open{display:block}
  </style>
</head>
<body class="bibrefs-page">
  <div id="site-header" data-include="partials/header.html"></div>

  <header class="page-header">
    <div class="container">
      <div class="head-row">
        <h1 class="page-title">Bible References</h1>
        <form class="omnibar" role="search" onsubmit="return false;">
          <input id="q" type="search" placeholder="Search terms (e.g., Zion, Sabbath, covenant)…  Try filters like: src:Easton type:Dictionary" aria-label="Search dictionary entries"/>
          <button id="clearBtn" class="btn" type="button">Clear</button>
        </form>
      </div>
      <div class="quick-filters" id="qf">
        <button class="qchip" data-filter="type:Dictionary">Dictionary</button>
        <button class="qchip" data-filter="type:Encyclopedia">Encyclopedia</button>
        <button class="qchip" data-filter="type:Lexicon">Lexicon</button>
        <button class="qchip" data-filter="scope:Tanakh">Tanakh</button>
        <button class="qchip" data-filter="scope:NT">NT</button>
        <button class="qchip" data-filter="scope:Apocrypha">Apocrypha</button>
        <button class="qchip" data-filter="src:Easton">Easton</button>
        <button class="qchip" data-filter="src:Hitchcock">Hitchcock</button>
        <button class="qchip" data-filter="src:ISD">ISD</button>
      </div>
      <div class="azbar" id="az"></div>
    </div>
  </header>

  <main class="container">
    <section class="layout">
      <aside class="results" id="results" aria-label="Results list"></aside>
      <article class="reader" id="reader" aria-live="polite">
        <div class="muted">Select an entry to read.</div>
      </article>
    </section>
  </main>

  <div id="site-footer" data-include="partials/footer.html"></div>
  <div id="hovercard" class="hovercard" role="dialog" aria-hidden="true"></div>

  <script src="/israelite-research/js/include.js"></script>
  <script>
    // ---------- Utility ----------
    const COMBINED_URL = "/israelite-research/data/dictionaries/_normalized/combined.json";
    const resultsEl = document.getElementById('results');
    const readerEl  = document.getElementById('reader');
    const qEl = document.getElementById('q');
    const clearBtn = document.getElementById('clearBtn');
    const hovercard = document.getElementById('hovercard');

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}

    function showHoverNear(anchorEl, html){
      if(!hovercard || !anchorEl) return;
      const r = anchorEl.getBoundingClientRect();
      hovercard.innerHTML = html;
      hovercard.style.left = (window.scrollX + r.left + Math.min(240, r.width)) + "px";
      hovercard.style.top  = (window.scrollY + r.top) + "px";
      hovercard.classList.add("open");
      hovercard.setAttribute("aria-hidden","false");
    }
    function hideHover(){
      if(!hovercard) return;
      hovercard.classList.remove("open");
      hovercard.setAttribute("aria-hidden","true");
    }
    document.addEventListener('click', (e)=>{ if(!e.target.closest('#hovercard,[data-ref]')) hideHover(); });

    // ---------- Ingest combined index ----------
    let ALL = [];      // {id,term,source,type,defs[],abstract,lettersKey,scope}
    let ACTIVE = [];   // filtered view
    let PINNED = [];   // for compare drawer later
    const A2Z = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    function detectScopeFromDefs(defs){
      const body = (defs||[]).join(" ").toLowerCase();
      if (body.includes("new testament") || body.includes("nt")) return "NT";
      if (body.includes("apocrypha")) return "Apocrypha";
      return "Tanakh/General";
    }

    function normalizeRow(row, i){
      const term = String(row.term||"").trim();
      const defs = Array.isArray(row.definitions) ? row.definitions.filter(Boolean) : [];
      const source = String(row.source||"Unknown").trim();
      const type = row.type ? String(row.type) : "Dictionary";
      const abstract = (defs[0]||"").replace(/\s+/g," ").trim().slice(0,300);
      const scope = row.scope || detectScopeFromDefs(defs);
      return {
        id:`${source}:${term.toLowerCase()}:${i}`, term, source, type, defs, abstract,
        lettersKey: term ? term[0].toUpperCase() : '#', scope
      };
    }

    async function loadCombined(){
      const res = await fetch(COMBINED_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const arr = await res.json();
      if(!Array.isArray(arr)) throw new Error("combined.json must be an array");
      ALL = arr.map(normalizeRow);
      ACTIVE = ALL.slice();
      renderAZ();
      renderResults();
    }

    // ---------- Filters / Search ----------
    const quickWrap = document.getElementById('qf');
    let activeFilters = new Set(); // strings like "src:Easton", "type:Dictionary", "scope:NT"
    function toggleFilter(f){
      if(activeFilters.has(f)) activeFilters.delete(f); else activeFilters.add(f);
      // reflect UI
      quickWrap.querySelectorAll('.qchip').forEach(ch=>{
        const key = ch.getAttribute('data-filter');
        ch.dataset.active = activeFilters.has(key) ? "1" : "0";
      });
      applyQuery(qEl.value);
    }
    quickWrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('.qchip');
      if(!btn) return;
      toggleFilter(btn.getAttribute('data-filter'));
    });

    function applyQuery(q){
      const query = String(q||"").trim().toLowerCase();
      ACTIVE = ALL.filter(row=>{
        // filter chips
        for(const f of activeFilters){
          const [k,v] = f.split(":");
          if(k==="src"   && row.source.toLowerCase() !== v.toLowerCase()) return false;
          if(k==="type"  && row.type.toLowerCase()   !== v.toLowerCase()) return false;
          if(k==="scope" && String(row.scope||"").toLowerCase().indexOf(v.toLowerCase())===-1) return false;
        }
        // free-text
        if(!query) return true;
        const hay = (row.term+" "+row.source+" "+row.abstract+" "+row.defs.join(" ")).toLowerCase();
        return hay.includes(query);
      });
      renderResults();
    }

    qEl.addEventListener('input', e=>applyQuery(e.target.value));
    clearBtn.addEventListener('click', ()=>{ qEl.value=""; activeFilters.clear(); quickWrap.querySelectorAll('.qchip').forEach(ch=>ch.dataset.active="0"); applyQuery(""); qEl.focus(); });

    function renderAZ(){
      const az = document.getElementById('az'); az.innerHTML="";
      A2Z.forEach(letter=>{
        const btn = document.createElement('button');
        btn.textContent = letter;
        btn.addEventListener('click', ()=>{
          applyQuery(qEl.value);
          // find first with this letter
          const idx = ACTIVE.findIndex(x=>x.lettersKey===letter);
          if(idx>-1){
            const target = resultsEl.querySelector(`[data-idx="${idx}"]`);
            if(target) target.scrollIntoView({behavior:"smooth", block:"start"});
          }
        });
        az.appendChild(btn);
      });
    }

    // ---------- Rendering ----------
    function renderResults(){
      if(!ACTIVE.length){
        resultsEl.innerHTML = `<p class="muted" style="padding:.3rem">No results.</p>`;
        readerEl.innerHTML  = `<div class="muted">Select an entry to read.</div>`;
        return;
      }
      const html = ACTIVE.map((e,i)=>`
        <article class="r-card" data-idx="${i}">
          <div class="r-top">
            <strong class="r-term">${escapeHtml(e.term)}</strong>
            <span class="r-src">${escapeHtml(e.source)}</span>
          </div>
          <div class="r-abs">${escapeHtml(e.abstract||"(no preview)")}</div>
          <div class="r-actions">
            <button data-open="${i}">Open</button>
            <button data-copy="${i}">Copy permalink</button>
            <button data-pin="${i}">Pin</button>
          </div>
        </article>
      `).join("");
      resultsEl.innerHTML = html;

      resultsEl.querySelectorAll('[data-open]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = +btn.getAttribute('data-open');
          const ent = ACTIVE[i];
          if(ent) openInReader(ent);
        });
      });
      resultsEl.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = +btn.getAttribute('data-copy');
          const ent = ACTIVE[i];
          const url = new URL(location.href);
          url.searchParams.set("term", ent.term);
          navigator.clipboard.writeText(url.toString());
          btn.textContent = "Copied!";
          setTimeout(()=>btn.textContent="Copy permalink",900);
        });
      });
      resultsEl.querySelectorAll('[data-pin]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = +btn.getAttribute('data-pin');
          const ent = ACTIVE[i];
          if(!ent) return;
          if(!PINNED.find(p=>p.id===ent.id)){ PINNED.push(ent); }
          btn.textContent = "Pinned";
          // Future: open compare drawer UI
        });
      });
    }

    function linkifyBibleRefs(text){
      // Simple pattern: Book Name 0:0  (basic, not exhaustive)
      return text.replace(/([1-3]?\s?[A-Z][a-z]+)\s(\d+):(\d+)/g, (m,book,chap,ver)=>{
        const href = `#`; // could deep-link into your chapter route if desired
        return `<a href="${href}" data-ref="${escapeHtml(book)} ${chap}:${ver}">${escapeHtml(m)}</a>`;
      });
    }

    function openInReader(ent){
      const defHtml = (ent.defs||[]).map(d=>`<p>${linkifyBibleRefs(escapeHtml(d))}</p>`).join("");
      readerEl.innerHTML = `
        <div class="rd-head">
          <h2 class="rd-title">${escapeHtml(ent.term)}</h2>
          <div class="rd-badges">
            <span class="badge">${escapeHtml(ent.source)}</span>
            <span class="badge">${escapeHtml(ent.type)}</span>
            <span class="badge">${escapeHtml(ent.scope || "General")}</span>
            <button class="badge" id="btnCite">Copy citation</button>
          </div>
        </div>
        <div class="rd-body">${defHtml || "<p class='muted'>(no content)</p>"}</div>
        <div class="muted" style="margin-top:.6rem">
          Source: ${escapeHtml(ent.source)}. For study use; verify with primary editions.
        </div>
      `;

      // Hover verses
      readerEl.querySelectorAll('[data-ref]').forEach(a=>{
        a.addEventListener('mouseenter', ()=>{
          const ref = a.getAttribute('data-ref') || "";
          showHoverNear(a, `<strong>${escapeHtml(ref)}</strong><div class="muted">Preview coming soon.</div>`);
        });
        a.addEventListener('mouseleave', hideHover);
      });

      // Copy citation (simple)
      const citeBtn = document.getElementById('btnCite');
      if(citeBtn){
        citeBtn.addEventListener('click', ()=>{
          const cite = `${ent.term}. ${ent.source}, “Bible Dictionary”. Accessed ${new Date().toISOString().slice(0,10)}.`;
          navigator.clipboard.writeText(cite);
          citeBtn.textContent = "Copied!";
          setTimeout(()=>citeBtn.textContent="Copy citation",900);
        });
      }
    }

    // Deep-link open via ?term=...
    function tryOpenFromQuery(){
      const term = new URLSearchParams(location.search).get("term");
      if(!term) return;
      const found = ALL.find(x=>x.term.toLowerCase() === term.toLowerCase());
      if(found) openInReader(found);
    }

    // Bootstrap
    (async function(){
      try{
        await loadCombined();
        tryOpenFromQuery();
      }catch(e){
        resultsEl.innerHTML = `<p class="muted">Failed to load dictionary index. ${escapeHtml(e.message)}</p>`;
      }
    })();
  </script>
</body>
</html>
